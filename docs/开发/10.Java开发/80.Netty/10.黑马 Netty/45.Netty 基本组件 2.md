---
title: åŸºæœ¬ç»„ä»¶ï¼šHandlerã€Pipeline ä¸ ByteBuf
date: 2023-11-12 19:02:00
permalink: /pages/java/netty/heima/handler/
categories:
  - å¼€å‘
  - Javaå¼€å‘
  - Netty
  - é»‘é©¬ Netty
tags:
  - 
---

## 1. Handler ä¸ Pipeline

> Pipeline å¥½æ¯”ä¸€æ¡æµæ°´çº¿ï¼ŒHandler å¥½æ¯”æµæ°´çº¿ä¸Šä¸€é“ä¸€é“çš„å·¥åºï¼Œä¸Šé¢æµåŠ¨çš„å°±æ˜¯ä½ è¦åˆ†æ‰¹å¤„ç†çš„æ•°æ®

ChannelHandler ç”¨æ¥å¤„ç† Channel ä¸Šçš„å„ç§äº‹ä»¶ï¼Œåˆ†ä¸ºå…¥ç«™ã€å‡ºç«™ä¸¤ç§ã€‚æ‰€æœ‰ ChannelHandler è¢«è¿æˆä¸€ä¸²ï¼Œå°±æ˜¯ Pipeline

- å…¥ç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelInboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦ç”¨æ¥è¯»å–å®¢æˆ·ç«¯æ•°æ®ï¼Œå†™å›ç»“æœ
- å‡ºç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelOutboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦å¯¹å†™å›ç»“æœè¿›è¡ŒåŠ å·¥

```java {14,23,34,41}
public class PipeLineServer {
    public static void main(String[] args) {
        new ServerBootstrap()
                .group(new NioEventLoopGroup())
                .channel(NioServerSocketChannel.class)
                .childHandler(new ChannelInitializer<SocketChannel>() {
                    @Override
                    protected void initChannel(SocketChannel socketChannel) throws Exception {
                        // åœ¨socketChannelçš„pipelineä¸­æ·»åŠ handler
                        // pipelineä¸­handleræ˜¯å¸¦æœ‰headä¸tailèŠ‚ç‚¹çš„åŒå‘é“¾è¡¨ï¼Œçš„å®é™…ç»“æ„ä¸º
                        // head <-> handler1 <-> ... <-> handler4 <->tail
                        // Inboundä¸»è¦å¤„ç†å…¥ç«™æ“ä½œï¼Œä¸€èˆ¬ä¸ºè¯»æ“ä½œï¼Œå‘ç”Ÿå…¥ç«™æ“ä½œæ—¶ä¼šè§¦å‘Inboundæ–¹æ³•
                        // å…¥ç«™æ—¶ï¼Œhandleræ˜¯ä»headå‘åè°ƒç”¨çš„
                        socketChannel.pipeline().addLast("handler1" ,new ChannelInboundHandlerAdapter() {
                            @Override
                            public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
                                System.out.println(Thread.currentThread().getName() + " Inbound handler 1");
                                // çˆ¶ç±»è¯¥æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨fireChannelRead
                                // å°†æ•°æ®ä¼ é€’ç»™ä¸‹ä¸€ä¸ªhandler
                                super.channelRead(ctx, msg);
                            }
                        });
                        socketChannel.pipeline().addLast("handler2", new ChannelInboundHandlerAdapter() {
                            @Override
                            public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
                                System.out.println(Thread.currentThread().getName() + " Inbound handler 2");
                                // æ‰§è¡Œwriteæ“ä½œï¼Œä½¿å¾—Outboundçš„æ–¹æ³•èƒ½å¤Ÿå¾—åˆ°è°ƒç”¨
          socketChannel.writeAndFlush(ctx.alloc().buffer().writeBytes("Server...".getBytes(StandardCharsets.UTF_8)));
                                super.channelRead(ctx, msg);
                            }
                        });
                        // Outboundä¸»è¦å¤„ç†å‡ºç«™æ“ä½œï¼Œä¸€èˆ¬ä¸ºå†™æ“ä½œï¼Œå‘ç”Ÿå‡ºç«™æ“ä½œæ—¶ä¼šè§¦å‘Outboundæ–¹æ³•
                        // å‡ºç«™æ—¶ï¼Œhandlerçš„è°ƒç”¨æ˜¯ä»tailå‘å‰è°ƒç”¨çš„
                        socketChannel.pipeline().addLast("handler3" ,new ChannelOutboundHandlerAdapter(){
                            @Override
                            public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception {
                                System.out.println(Thread.currentThread().getName() + " Outbound handler 1");
                                super.write(ctx, msg, promise);
                            }
                        });
                        socketChannel.pipeline().addLast("handler4" ,new ChannelOutboundHandlerAdapter(){
                            @Override
                            public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception {
                                System.out.println(Thread.currentThread().getName() + " Outbound handler 2");
                                super.write(ctx, msg, promise);
                            }
                        });
                    }
                })
                .bind(8080);
    }
}
```

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

```plain
nioEventLoopGroup-2-2 Inbound handler 1
nioEventLoopGroup-2-2 Inbound handler 2
nioEventLoopGroup-2-2 Outbound handler 2
nioEventLoopGroup-2-2 Outbound handler 1
```

é€šè¿‡ **channel.pipeline().addLast(name, handler)** å¯ä»¥åœ¨ pipeline ä¸­æ·»åŠ  handlerï¼Œ**è®°å¾—ç»™ handler å–åå­—**ï¼Œè¿™æ ·å¯ä»¥è°ƒç”¨ pipeline çš„ addAfterã€addBefore ç­‰æ–¹æ³•æ›´çµæ´»åœ°å‘ pipeline ä¸­æ·»åŠ  handlerã€‚

handler éœ€è¦æ”¾å…¥é€šé“çš„ pipeline ä¸­ï¼Œæ‰èƒ½æ ¹æ®æ”¾å…¥é¡ºåºæ¥ä½¿ç”¨ handlerï¼š

- **pipeline æ˜¯ç»“æ„æ˜¯ä¸€ä¸ªå¸¦æœ‰ head ä¸ tail æŒ‡é’ˆçš„åŒå‘é“¾è¡¨ï¼Œå…¶ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ä¸º handler**
  - è¦é€šè¿‡ `ctx.fireChannelRead(msg)` ç­‰æ–¹æ³•ï¼Œå°†å½“å‰ handler çš„å¤„ç†ç»“æœä¼ é€’ç»™ä¸‹ä¸€ä¸ª handler
  - `ctx.fireChannelRead(msg)` å·²ç»è¢« `super.channelRead()` æˆ– `super.write()` æ‰€å°è£…
  - å¦‚æœä¸ç›´æ¥æˆ–é—´æ¥è°ƒç”¨è¿™ä¸ª `ctx.fireChannelRead(msg)`ï¼Œé‚£è°ƒç”¨é“¾å°±ä¼šæ–­æ‰ã€‚
- å½“æœ‰<mark>å…¥ç«™ï¼ˆInboundï¼‰</mark>æ“ä½œæ—¶ï¼Œä¼šä» head å¼€å§‹å‘åè°ƒç”¨ handlerï¼Œç›´åˆ° handler ä¸æ˜¯å¤„ç† Inbound æ“ä½œä¸ºæ­¢
- å½“æœ‰<mark>å‡ºç«™ï¼ˆOutboundï¼‰</mark>æ“ä½œæ—¶ï¼Œä¼šä» tail å¼€å§‹å‘å‰è°ƒç”¨ handlerï¼Œç›´åˆ° handler ä¸æ˜¯å¤„ç† Outbound æ“ä½œä¸ºæ­¢

ç»“æ„å¦‚ä¸‹ï¼š

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/20231112210721.png" alt="20231112210721" style="zoom:75%;" /></center>

è°ƒç”¨é¡ºåºå¦‚ä¸‹ï¼š

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/20231112210806.png" alt="20231112210806" style="zoom:75%;" /></center>

### 1.1 Inbound Handler

ä»¥ç¤ºä¾‹ä»£ç çš„ handler 1ã€handler 2 ä¸ºä¾‹ï¼Œçœ‹ä¸€ä¸‹ Inbound Handlerã€‚

å…¥ç«™å¤„ç†å™¨ç»§æ‰¿è‡ª ChannelInboundHandlerAdapterï¼Œéœ€è¦é‡å†™å…¶ä¸­çš„ `channelRead` æ¥å¤„ç†è¯»å–çš„æ¶ˆæ¯ `Object msg`ã€‚ç¬¬ä¸€ä¸ª handler å¾—åˆ°çš„ msg å°±æ˜¯åŸå§‹ IO è¯»å–åˆ°çš„æ•°æ®ï¼Œåé¢ handler å¾—åˆ°çš„ msg æ˜¯å‰é¢ handler å¤„ç†åä¼ ç»™ä»–çš„ msgã€‚æ¯ä¸€ä¸ª handler åœ¨å¤„ç†å®Œ msg åï¼Œè°ƒç”¨ `super.channelRead(ctx, msg);` æ¥äº¤ç”±ä¸‹ä¸€ä¸ª  inbound handlerã€‚

### 1.2 Outbound Handler

ä»¥ç¤ºä¾‹ä»£ç çš„ handler 3ã€handler 4 ä¸ºä¾‹ï¼Œçœ‹ä¸€ä¸‹ Inbound Handlerã€‚

å‡ºç«™å¤„ç†å™¨ç»§æ‰¿è‡ª ChannelOutboundHandlerAdapterï¼Œéœ€è¦é‡å†™å…¶ä¸­çš„ `write` æ¥å¤„ç†å¯¹å¤–å†™çš„æ¶ˆæ¯ï¼Œåœ¨ handler å¤„ç†å®Œä¹‹åï¼Œéœ€è¦è°ƒç”¨ `super.write(ctx, msg, promise)` æ¥äº¤ç”±ä¸Šä¸€ä¸ª outbound handlerã€‚

å°ç»†èŠ‚ï¼š`socketChannel.writeAndFlush` VS `ctx.writeAndFlush()`

- `socketChannel.writeAndFlush()`ï¼šå½“handlerä¸­è°ƒç”¨è¯¥æ–¹æ³•è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œä¼šè§¦å‘Outboundæ“ä½œï¼Œ**æ­¤æ—¶æ˜¯ä»tailå‘å‰å¯»æ‰¾OutboundHandler**

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/20231112212912.png" alt="20231112212912" style="zoom:75%;" /></center>

- `ctx.writeAndFlush()`ï¼šå½“handlerä¸­è°ƒç”¨è¯¥æ–¹æ³•è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œä¼šè§¦å‘Outboundæ“ä½œï¼Œ**æ­¤æ—¶æ˜¯ä»å½“å‰handlerå‘å‰å¯»æ‰¾OutboundHandler**

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/20231112212943.png" alt="20231112212943" style="zoom:75%;" /></center>

`super.write()` æ˜¯å¯¹ `socketChannel.writeAndFlush()`ï¼Œè¿™æ‰æ˜¯åˆç†çš„ï¼Œæ‰€ä»¥åº”è¯¥åœ¨ handler ä¸­è°ƒç”¨è¿™ä¸ªã€‚

### 1.3 EmbeddedChannel

EmbeddedChannel æ˜¯ä¸€ä¸ªç”¨äºè°ƒè¯•çš„å·¥å…·ç±»ï¼Œå¯ä»¥ç”¨äºæµ‹è¯•å„ä¸ª handlerã€‚é€šè¿‡å…¶æ„é€ å‡½æ•°æŒ‰é¡ºåºä¼ å…¥éœ€è¦æµ‹è¯• handlerï¼Œç„¶åè°ƒç”¨å¯¹åº”çš„ Inbound å’Œ Outbound æ–¹æ³•å³å¯ã€‚

```java
public class TestEmbeddedChannel {
    public static void main(String[] args) {
        ChannelInboundHandlerAdapter h1 = new ChannelInboundHandlerAdapter() {
            @Override
            public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
                System.out.println("1");
                super.channelRead(ctx, msg);
            }
        };

        ChannelInboundHandlerAdapter h2 = new ChannelInboundHandlerAdapter() {
            @Override
            public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
                System.out.println("2");
                super.channelRead(ctx, msg);
            }
        };

        ChannelOutboundHandlerAdapter h3 = new ChannelOutboundHandlerAdapter() {
            @Override
            public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception {
                System.out.println("3");
                super.write(ctx, msg, promise);
            }
        };

        ChannelOutboundHandlerAdapter h4 = new ChannelOutboundHandlerAdapter() {
            @Override
            public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception {
                System.out.println("4");
                super.write(ctx, msg, promise);
            }
        };

        // ç”¨äºæµ‹è¯•Handlerçš„Channel
        EmbeddedChannel channel = new EmbeddedChannel(h1, h2, h3, h4);
        
        // æ¨¡æ‹Ÿå…¥ç«™æ“ä½œï¼Œæ‰§è¡Œ Inbound æ“ä½œ 
        channel.writeInbound(ByteBufAllocator.DEFAULT.buffer().writeBytes("hello".getBytes(StandardCharsets.UTF_8)));
        // æ¨¡æ‹Ÿå‡ºç«™æ“ä½œï¼Œæ‰§è¡Œ Outbound æ“ä½œ
        channel.writeOutbound(ByteBufAllocator.DEFAULT.buffer().writeBytes("hello".getBytes(StandardCharsets.UTF_8)));
    }
}
```

## 2. ByteBuf

ByteBuf æ˜¯å¯¹ NIO ä¸­çš„ ByteBuffer çš„å¢å¼ºã€‚

ä¸ºäº†æ–¹ä¾¿ï¼Œå…ˆå†™ä¸€ä¸ªè°ƒè¯•å·¥å…·æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´ä¸ºè¯¦ç»†åœ°æŸ¥çœ‹ ByteBuf ä¸­çš„å†…å®¹ï¼š

```java
private static void log(ByteBuf buffer) {
    int length = buffer.readableBytes();
    int rows = length / 16 + (length % 15 == 0 ? 0 : 1) + 4;
    StringBuilder buf = new StringBuilder(rows * 80 * 2)
        .append("read index:").append(buffer.readerIndex())
        .append(" write index:").append(buffer.writerIndex())
        .append(" capacity:").append(buffer.capacity())
        .append(NEWLINE);
    appendPrettyHexDump(buf, buffer);
    System.out.println(buf.toString());
}
```

### 2.1 ByteBuf çš„åˆ›å»º

- ä½¿ç”¨ `ByteBufAllocator.DEFAULT.buffer()` å¯ä»¥åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ ByteBuf

```java
public class ByteBufStudy {
    public static void main(String[] args) {
        // åˆ›å»ºByteBuf
        ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer(16);
        ByteBufUtil.log(buffer);

        // å‘bufferä¸­å†™å…¥æ•°æ®
        StringBuilder sb = new StringBuilder();
        for(int i = 0; i < 20; i++) {
            sb.append("a");
        }
        buffer.writeBytes(sb.toString().getBytes(StandardCharsets.UTF_8));

        // æŸ¥çœ‹å†™å…¥ç»“æœ
        ByteBufUtil.log(buffer);
    }
}
```

**ByteBuf é€šè¿‡ ByteBufAllocator é€‰æ‹© allocator å¹¶è°ƒç”¨å¯¹åº”çš„ buffer() æ–¹æ³•æ¥åˆ›å»º**çš„ï¼Œ**é»˜è®¤ä½¿ç”¨ç›´æ¥å†…å­˜**ä½œä¸º ByteBufï¼Œå®¹é‡ä¸º 256 ä¸ªå­—èŠ‚ï¼Œå¯ä»¥æŒ‡å®šåˆå§‹å®¹é‡çš„å¤§å°ã€‚

å½“ ByteBuf çš„å®¹é‡æ— æ³•å®¹çº³æ‰€æœ‰æ•°æ®æ—¶ï¼ŒByteBuf ä¼šè¿›è¡Œ**è‡ªåŠ¨æ‰©å®¹**æ“ä½œã€‚

**å¦‚æœåœ¨ handler ä¸­åˆ›å»º ByteBufï¼Œå»ºè®®ä½¿ç”¨ `ChannelHandlerContext ctx.alloc().buffer()` æ¥åˆ›å»º**ã€‚

### 2.2 ç›´æ¥å†…å­˜ vs å †å†…å­˜

ä¹‹å‰è¯´è¿‡ï¼Œå †å†…å­˜çš„åˆ†é…æ•ˆç‡æ¯”è¾ƒé«˜ï¼Œä½†è¯»å†™æ•ˆç‡æ¯”è¾ƒä½ï¼Œè€Œç›´æ¥å†…å­˜åˆ†é…æ•ˆç‡æ¯”è¾ƒä½ï¼Œä½†è¯»å†™æ•ˆç‡æ¯”è¾ƒé«˜ï¼ˆå› ä¸º zero-copyï¼‰ã€‚

- åˆ›å»ºæ± åŒ–åŸºäºå †å†…å­˜çš„ ByteBufï¼š`ByteBufAllocator.DEFAULT.heapBuffer(16);`
- åˆ›å»ºæ± åŒ–åŸºäºç›´æ¥å†…å­˜çš„ ByteBufï¼š`yteBufAllocator.DEFAULT.directBuffer(16);` æˆ– `ByteBufAllocator.DEFAULT.buffer(16);`

åœ¨é€‰æ‹©æ—¶ï¼Œéœ€è¦è€ƒè™‘åˆ°ï¼š

- ç›´æ¥å†…å­˜åˆ›å»ºå’Œé”€æ¯çš„ä»£ä»·æ˜‚è´µï¼Œä½†è¯»å†™æ€§èƒ½é«˜ï¼ˆå°‘ä¸€æ¬¡å†…å­˜å¤åˆ¶ï¼‰ï¼Œé€‚åˆé…åˆæ± åŒ–åŠŸèƒ½ä¸€èµ·ç”¨
- ç›´æ¥å†…å­˜å¯¹ GC å‹åŠ›å°ï¼Œå› ä¸ºè¿™éƒ¨åˆ†å†…å­˜ä¸å— JVM åƒåœ¾å›æ”¶çš„ç®¡ç†ï¼Œä½†ä¹Ÿè¦æ³¨æ„åŠæ—¶ä¸»åŠ¨é‡Šæ”¾

### 2.3 æ± åŒ– vs éæ± åŒ–

è¿™é‡Œçš„æ± åŒ–æ˜¯æŒ‡å¯¹åˆ†é…çš„å†…å­˜çš„æ± åŒ–ï¼Œé¿å…æ¯æ¬¡ä½¿ç”¨å†…å­˜éƒ½æ˜¯ç”³è¯·å†…å­˜å†é‡Šæ”¾å†…å­˜ã€‚æ± åŒ–çš„æœ€å¤§æ„ä¹‰åœ¨äºå¯ä»¥**é‡ç”¨** ByteBufï¼Œä¼˜ç‚¹æœ‰ï¼š

- æ²¡æœ‰æ± åŒ–ï¼Œåˆ™æ¯æ¬¡éƒ½å¾—åˆ›å»ºæ–°çš„ ByteBuf å®ä¾‹ï¼Œè¿™ä¸ªæ“ä½œå¯¹ç›´æ¥å†…å­˜ä»£ä»·æ˜‚è´µï¼Œå°±ç®—æ˜¯å †å†…å­˜ï¼Œä¹Ÿä¼šå¢åŠ  GC å‹åŠ›
- æœ‰äº†æ± åŒ–ï¼Œåˆ™å¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œå¹¶ä¸”é‡‡ç”¨äº†ä¸ jemalloc ç±»ä¼¼çš„å†…å­˜åˆ†é…ç®—æ³•æå‡åˆ†é…æ•ˆç‡
- é«˜å¹¶å‘æ—¶ï¼Œæ± åŒ–åŠŸèƒ½æ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½

æ± åŒ–åŠŸèƒ½æ˜¯å¦å¼€å¯ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„ç³»ç»Ÿç¯å¢ƒå˜é‡æ¥è®¾ç½®ï¼š

```plain
-Dio.netty.allocator.type={unpooled|pooled}
```

> - 4.1 ä»¥åï¼Œé Android å¹³å°é»˜è®¤å¯ç”¨æ± åŒ–å®ç°ï¼ŒAndroid å¹³å°å¯ç”¨éæ± åŒ–å®ç°
> - 4.1 ä¹‹å‰ï¼Œæ± åŒ–åŠŸèƒ½è¿˜ä¸æˆç†Ÿï¼Œé»˜è®¤æ˜¯éæ± åŒ–å®ç°

çœ‹ä¸€ä¸‹ä¾‹å­ï¼š

```java
public class ByteBufStudy {
    public static void main(String[] args) {
        ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer(16);
        System.out.println(buffer.getClass());

        buffer = ByteBufAllocator.DEFAULT.heapBuffer(16);
        System.out.println(buffer.getClass());

        buffer = ByteBufAllocator.DEFAULT.directBuffer(16);
        System.out.println(buffer.getClass());
    }
}
```

æ‰“å°ç»“æœï¼š

```plain
// ä½¿ç”¨æ± åŒ–çš„ç›´æ¥å†…å­˜
class io.netty.buffer.PooledUnsafeDirectByteBuf
    
// ä½¿ç”¨æ± åŒ–çš„å †å†…å­˜    
class io.netty.buffer.PooledUnsafeHeapByteBuf
    
// ä½¿ç”¨æ± åŒ–çš„ç›´æ¥å†…å­˜    
class io.netty.buffer.PooledUnsafeDirectByteBuf
```

### 2.4 ByteBuf çš„ç»„æˆ

ByteBuf ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªç»„æˆéƒ¨åˆ†ï¼š

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/20231118103203.png" alt="20231118103203" style="zoom:75%;" /></center>

- **æœ€å¤§å®¹é‡**ä¸**å½“å‰å®¹é‡**
  - åœ¨æ„é€  ByteBuf æ—¶ï¼Œå¯ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ä»£è¡¨åˆå§‹å®¹é‡å’Œæœ€å¤§å®¹é‡ï¼Œè‹¥æœªä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°ï¼ˆæœ€å¤§å®¹é‡ï¼‰ï¼Œæœ€å¤§å®¹é‡é»˜è®¤ä¸º Integer.MAX_VALUE
  - å½“ ByteBuf å®¹é‡æ— æ³•å®¹çº³æ‰€æœ‰æ•°æ®æ—¶ï¼Œä¼šè¿›è¡Œæ‰©å®¹æ“ä½œï¼Œè‹¥è¶…å‡ºæœ€å¤§å®¹é‡ï¼Œä¼šæŠ›å‡º `java.lang.IndexOutOfBoundsException` å¼‚å¸¸
- è¯»å†™æ“ä½œä¸åŒäº ByteBuffer åªç”¨ position è¿›è¡Œæ§åˆ¶ï¼Œ**ByteBuf åˆ†åˆ«ç”±è¯»æŒ‡é’ˆå’Œå†™æŒ‡é’ˆä¸¤ä¸ªæŒ‡é’ˆæ§åˆ¶**ã€‚è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œæ— éœ€è¿›è¡Œæ¨¡å¼çš„åˆ‡æ¢
  - è¯»æŒ‡é’ˆå‰çš„éƒ¨åˆ†è¢«ç§°ä¸º**åºŸå¼ƒéƒ¨åˆ†**ï¼Œæ˜¯å·²ç»è¯»è¿‡çš„å†…å®¹
  - è¯»æŒ‡é’ˆä¸å†™æŒ‡é’ˆä¹‹é—´çš„ç©ºé—´ç§°ä¸º**å¯è¯»éƒ¨åˆ†**
  - å†™æŒ‡é’ˆä¸å½“å‰å®¹é‡ä¹‹é—´çš„ç©ºé—´ç§°ä¸º**å¯å†™éƒ¨åˆ†**

### 2.5 ByteBuf çš„å†™å…¥

å¸¸ç”¨æ–¹æ³•ï¼š

| æ–¹æ³•ç­¾å                                                     | å«ä¹‰                   | å¤‡æ³¨                                        |
| ------------------------------------------------------------ | ---------------------- | ------------------------------------------- |
| writeBoolean(boolean value)                                  | å†™å…¥ boolean å€¼        | ç”¨ä¸€å­—èŠ‚ 01\|00 ä»£è¡¨ true\|false            |
| writeByte(int value)                                         | å†™å…¥ byte å€¼           |                                             |
| writeShort(int value)                                        | å†™å…¥ short å€¼          |                                             |
| writeInt(int value)                                          | å†™å…¥ int å€¼            | Big Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 00 00 02 50    |
| writeIntLE(int value)                                        | å†™å…¥ int å€¼            | Little Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 50 02 00 00 |
| writeLong(long value)                                        | å†™å…¥ long å€¼           |                                             |
| writeChar(int value)                                         | å†™å…¥ char å€¼           |                                             |
| writeFloat(float value)                                      | å†™å…¥ float å€¼          |                                             |
| writeDouble(double value)                                    | å†™å…¥ double å€¼         |                                             |
| writeBytes(ByteBuf src)                                      | å†™å…¥ netty çš„ ByteBuf  |                                             |
| writeBytes(byte[] src)                                       | å†™å…¥ byte[]            |                                             |
| writeBytes(ByteBuffer src)                                   | å†™å…¥ nio çš„ ByteBuffer |                                             |
| int writeCharSequence(CharSequence sequence, Charset charset) | å†™å…¥å­—ç¬¦ä¸²             |

- è¿™äº›æ–¹æ³•çš„æœªæŒ‡æ˜è¿”å›å€¼çš„ï¼Œå…¶è¿”å›å€¼éƒ½æ˜¯ ByteBufï¼Œæ„å‘³ç€å¯ä»¥é“¾å¼è°ƒç”¨æ¥å†™å…¥ä¸åŒçš„æ•°æ®
- ç½‘ç»œä¼ è¾“ä¸­ï¼Œé»˜è®¤ä¹ æƒ¯æ˜¯ Big Endianï¼Œä½¿ç”¨ writeInt(int value)

### 2.6 æ‰©å®¹

å½“ ByteBuf ä¸­çš„å®¹é‡æ— æ³•å®¹çº³å†™å…¥çš„æ•°æ®æ—¶ï¼Œä¼šè¿›è¡Œæ‰©å®¹æ“ä½œï¼š

```java
buffer.writeLong(7);
ByteBufUtil.log(buffer);
```

ç»“æœï¼š

```plain
// æ‰©å®¹å‰
read index:0 write index:12 capacity:16
...

// æ‰©å®¹å
read index:0 write index:20 capacity:20
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 00 00 00 05 06 00 00 00 00 00 00 00 |................|
|00000010| 00 00 00 07                                     |....            |
+--------+-------------------------------------------------+----------------+
```

æ‰©å®¹è§„åˆ™ï¼š

- å¦‚ä½•å†™å…¥åæ•°æ®å¤§å°æœªè¶…è¿‡ 512 å­—èŠ‚ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 16 çš„æ•´æ•°å€è¿›è¡Œæ‰©å®¹
  - ä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 12 å­—èŠ‚ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 16 å­—èŠ‚
- å¦‚æœå†™å…¥åæ•°æ®å¤§å°è¶…è¿‡ 512 å­—èŠ‚ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 2n
  - ä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 513 å­—èŠ‚ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 210=1024 å­—èŠ‚ï¼ˆ29=512 å·²ç»ä¸å¤Ÿäº†ï¼‰
- æ‰©å®¹**ä¸èƒ½è¶…è¿‡** maxCapacityï¼Œå¦åˆ™ä¼šæŠ›å‡º `java.lang.IndexOutOfBoundsException` å¼‚å¸¸

### 2.7 è¯»å–

è¯»å–ä¸»è¦æ˜¯é€šè¿‡ä¸€ç³»åˆ— read æ–¹æ³•è¿›è¡Œè¯»å–ï¼Œè¯»å–æ—¶ä¼šæ ¹æ®è¯»å–æ•°æ®çš„å­—èŠ‚æ•°ç§»åŠ¨è¯»æŒ‡é’ˆ

å¦‚æœéœ€è¦é‡å¤è¯»å–ï¼Œéœ€è¦è°ƒç”¨ `buffer.markReaderIndex()` å¯¹è¯»æŒ‡é’ˆè¿›è¡Œæ ‡è®°ï¼Œå¹¶é€šè¿‡ `buffer.resetReaderIndex()` å°†è¯»æŒ‡é’ˆæ¢å¤åˆ° mark æ ‡è®°çš„ä½ç½®ï¼š

```java
public class ByteBufStudy {
    public static void main(String[] args) {
        // åˆ›å»ºByteBuf
        ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer(16, 20);

        // å‘bufferä¸­å†™å…¥æ•°æ®
        buffer.writeBytes(new byte[]{1, 2, 3, 4});
        buffer.writeInt(5);

        // è¯»å–4ä¸ªå­—èŠ‚
        System.out.println(buffer.readByte());
        System.out.println(buffer.readByte());
        System.out.println(buffer.readByte());
        System.out.println(buffer.readByte());
        ByteBufUtil.log(buffer);

        // é€šè¿‡markä¸resetå®ç°é‡å¤è¯»å–
        buffer.markReaderIndex();
        System.out.println(buffer.readInt());
        ByteBufUtil.log(buffer);

        // æ¢å¤åˆ°markæ ‡è®°å¤„
        buffer.resetReaderIndex();
        ByteBufUtil.log(buffer);
    }
}
```

æ‰“å°ç»“æœï¼š

```plain
1
2
3
4
read index:4 write index:8 capacity:16
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 00 00 00 05                                     |....            |
+--------+-------------------------------------------------+----------------+
5
read index:8 write index:8 capacity:16

read index:4 write index:8 capacity:16
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 00 00 00 05                                     |....            |
+--------+-------------------------------------------------+----------------+
```

è¿˜æœ‰ä»¥ get å¼€å¤´çš„ä¸€ç³»åˆ—æ–¹æ³•ï¼Œ**è¿™äº›æ–¹æ³•ä¸ä¼šæ”¹å˜è¯»æŒ‡é’ˆçš„ä½ç½®**

### 2.8 ByteBuf çš„å†…å­˜å›æ”¶

ç”±äº Netty ä¸­æœ‰å †å¤–å†…å­˜ï¼ˆç›´æ¥å†…å­˜ï¼‰çš„ ByteBuf å®ç°ï¼Œ**å †å¤–å†…å­˜æœ€å¥½æ˜¯æ‰‹åŠ¨æ¥é‡Šæ”¾**ï¼Œè€Œä¸æ˜¯ç­‰ GC åƒåœ¾å›æ”¶ã€‚

- UnpooledHeapByteBuf ä½¿ç”¨çš„æ˜¯ JVM å†…å­˜ï¼Œåªéœ€ç­‰ GC å›æ”¶å†…å­˜å³å¯
- UnpooledDirectByteBuf ä½¿ç”¨çš„å°±æ˜¯ç›´æ¥å†…å­˜äº†ï¼Œéœ€è¦ç‰¹æ®Šçš„æ–¹æ³•æ¥å›æ”¶å†…å­˜
- PooledByteBuf å’Œå®ƒçš„å­ç±»ä½¿ç”¨äº†æ± åŒ–æœºåˆ¶ï¼Œéœ€è¦æ›´å¤æ‚çš„è§„åˆ™æ¥å›æ”¶å†…å­˜

Netty è¿™é‡Œé‡‡ç”¨äº†**å¼•ç”¨è®¡æ•°æ³•**æ¥æ§åˆ¶å›æ”¶å†…å­˜ï¼Œ**æ¯ä¸ª ByteBuf éƒ½å®ç°äº† ReferenceCounted æ¥å£**ï¼š

- æ¯ä¸ª ByteBuf å¯¹è±¡çš„åˆå§‹è®¡æ•°ä¸º 1
- è°ƒç”¨ release æ–¹æ³•è®¡æ•°å‡ 1ï¼Œå¦‚æœè®¡æ•°ä¸º 0ï¼ŒByteBuf å†…å­˜è¢«å›æ”¶
- è°ƒç”¨ retain æ–¹æ³•è®¡æ•°åŠ  1ï¼Œè¡¨ç¤ºè°ƒç”¨è€…æ²¡ç”¨å®Œä¹‹å‰ï¼Œå…¶å®ƒ handler å³ä½¿è°ƒç”¨äº† release ä¹Ÿä¸ä¼šé€ æˆå›æ”¶
- å½“è®¡æ•°ä¸º 0 æ—¶ï¼Œåº•å±‚å†…å­˜ä¼šè¢«å›æ”¶ï¼Œè¿™æ—¶å³ä½¿ ByteBuf å¯¹è±¡è¿˜åœ¨ï¼Œå…¶å„ä¸ªæ–¹æ³•å‡æ— æ³•æ­£å¸¸ä½¿ç”¨

#### 2.8.1 é‡Šæ”¾è§„åˆ™

ç”±äº handler pipeline çš„å­˜åœ¨ï¼Œä¸€èˆ¬éœ€è¦å°† ByteBuf ä¼ é€’ç»™ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¦‚æœåœ¨æ¯ä¸ª ChannelHandler ä¸­éƒ½å»è°ƒç”¨ release ï¼Œå°±å¤±å»äº†ä¼ é€’æ€§ï¼ˆå¦‚æœåœ¨è¿™ä¸ª ChannelHandler å†…è¿™ä¸ª ByteBuf å·²å®Œæˆäº†å®ƒçš„ä½¿å‘½ï¼Œé‚£ä¹ˆä¾¿æ— é¡»å†ä¼ é€’ï¼‰

**åŸºæœ¬è§„åˆ™æ˜¯ï¼Œå“ªä¸ª handler æ˜¯æœ€åä½¿ç”¨è€…ï¼Œå“ªä¸ª handler è´Ÿè´£ release**ï¼š

- èµ·ç‚¹ï¼Œå¯¹äº NIO å®ç°æ¥è®²ï¼Œåœ¨ io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe.read æ–¹æ³•ä¸­é¦–æ¬¡åˆ›å»º ByteBuf æ”¾å…¥ pipeline
- å…¥ç«™ ByteBuf å¤„ç†åŸåˆ™
  - å¯¹åŸå§‹ ByteBuf ä¸åšå¤„ç†ï¼Œè°ƒç”¨ ctx.fireChannelRead(msg) å‘åä¼ é€’ï¼Œè¿™æ—¶æ— é¡» release
  - **å°†åŸå§‹ ByteBuf è½¬æ¢ä¸ºå…¶å®ƒç±»å‹çš„ Java å¯¹è±¡ï¼Œè¿™æ—¶ ByteBuf å°±æ²¡ç”¨äº†ï¼Œå¿…é¡» release**
  - **å¦‚æœä¸è°ƒç”¨ ctx.fireChannelRead(msg) å‘åä¼ é€’ï¼Œé‚£ä¹ˆä¹Ÿå¿…é¡» release**
  - **æ³¨æ„å„ç§å¼‚å¸¸ï¼Œå¦‚æœ ByteBuf æ²¡æœ‰æˆåŠŸä¼ é€’åˆ°ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¿…é¡» release**
  - å‡è®¾æ¶ˆæ¯ä¸€ç›´å‘åä¼ ï¼Œé‚£ä¹ˆ TailContext ä¼šè´Ÿè´£é‡Šæ”¾æœªå¤„ç†æ¶ˆæ¯ï¼ˆåŸå§‹çš„ ByteBufï¼‰
- å‡ºç«™ ByteBuf å¤„ç†åŸåˆ™
  - **å‡ºç«™æ¶ˆæ¯æœ€ç»ˆéƒ½ä¼šè½¬ä¸º ByteBuf è¾“å‡ºï¼Œä¸€ç›´å‘å‰ä¼ ï¼Œç”± HeadContext flush å release**
- å¼‚å¸¸å¤„ç†åŸåˆ™
  - æœ‰æ—¶å€™ä¸æ¸…æ¥š ByteBuf è¢«å¼•ç”¨äº†å¤šå°‘æ¬¡ï¼Œä½†åˆå¿…é¡»å½»åº•é‡Šæ”¾ï¼Œå¯ä»¥å¾ªç¯è°ƒç”¨ release ç›´åˆ°è¿”å› true

```java
while (!buffer.release()) {}
```

**å½“ ByteBuf è¢«ä¼ åˆ°äº† pipeline çš„ head ä¸ tail æ—¶ï¼ŒByteBuf ä¼šè¢«å…¶ä¸­çš„æ–¹æ³•å½»åº•é‡Šæ”¾ï¼Œä½†å‰ææ˜¯ ByteBuf è¢«ä¼ é€’åˆ°äº† head ä¸ tail ä¸­**ã€‚

#### 2.8.2 TailConext ä¸­é‡Šæ”¾ ByteBuf çš„æºç 

```java
protected void onUnhandledInboundMessage(Object msg) {
    try {
        logger.debug("Discarded inbound message {} that reached at the tail of the pipeline. Please check your pipeline configuration.", msg);
    } finally {
        // å…·ä½“çš„é‡Šæ”¾æ–¹æ³•
        ReferenceCountUtil.release(msg);
    }
}
```

åˆ¤æ–­ä¼ è¿‡æ¥çš„æ˜¯å¦ä¸º ByteBufï¼Œæ˜¯çš„è¯æ‰éœ€è¦é‡Šæ”¾ï¼š

```java
public static boolean release(Object msg) {
    return msg instanceof ReferenceCounted ? ((ReferenceCounted)msg).release() : false;
}
```

### 2.9 åˆ‡ç‰‡ï¼ˆSliceï¼‰

åˆ‡ç‰‡æ“ä½œï¼š`ByteBuf slice1 = buffer.slice(0, 5);`

ByteBuf çš„**åˆ‡ç‰‡æ˜¯é›¶æ‹·è´çš„ä½“ç°ä¹‹ä¸€**ã€‚å¯¹åŸå§‹ ByteBuf è¿›è¡Œåˆ‡ç‰‡æˆå¤šä¸ª ByteBufï¼Œåˆ‡ç‰‡åçš„ ByteBuf å¹¶æ²¡æœ‰å‘ç”Ÿå†…å­˜å¤åˆ¶ï¼Œè¿˜æ˜¯ä½¿ç”¨åŸå§‹ ByteBuf çš„å†…å­˜ï¼Œåˆ‡ç‰‡åçš„ ByteBuf ç»´æŠ¤ç‹¬ç«‹çš„ readã€write æŒ‡é’ˆã€‚

> è¿™é‡Œçš„â€œé›¶æ‹·è´â€è¯´çš„æ˜¯ä»å‡å°‘æ•°æ®å¤åˆ¶çš„è§’åº¦æ¥è¯´çš„ï¼Œå¹¶ä¸æ˜¯è¯´çš„æ“ä½œç³»ç»Ÿçš„é›¶æ‹·è´ã€‚

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/20231118140255.png" alt="20231118140255" style="zoom:75%;" /></center>

ä¿®æ”¹åŸ ByteBuf ä¸­çš„å€¼ï¼Œä¹Ÿä¼šå½±å“åˆ‡ç‰‡åå¾—åˆ°çš„ ByteBufã€‚

å¾—åˆ°åˆ†ç‰‡åçš„ buffer åï¼Œè¦è°ƒç”¨å…¶ `retain` æ–¹æ³•ï¼Œä½¿å…¶å†…éƒ¨çš„å¼•ç”¨è®¡æ•°åŠ ä¸€ã€‚é¿å…åŸ ByteBuf é‡Šæ”¾ï¼Œå¯¼è‡´åˆ‡ç‰‡ buffer æ— æ³•ä½¿ç”¨

ä¸€ä¸ªä½¿ç”¨ç¤ºä¾‹ï¼š

```java
public class TestSlice {
    public static void main(String[] args) {
        // åˆ›å»ºByteBuf
        ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer(16, 20);

        // å‘bufferä¸­å†™å…¥æ•°æ®
        buffer.writeBytes(new byte[]{1, 2, 3, 4, 5, 6, 7, 8, 9, 10});

        // å°†bufferåˆ†æˆä¸¤éƒ¨åˆ†
        ByteBuf slice1 = buffer.slice(0, 5);
        ByteBuf slice2 = buffer.slice(5, 5);

        // éœ€è¦è®©åˆ†ç‰‡çš„bufferå¼•ç”¨è®¡æ•°åŠ ä¸€
        // é¿å…åŸBufferé‡Šæ”¾å¯¼è‡´åˆ†ç‰‡bufferæ— æ³•ä½¿ç”¨
        slice1.retain();
        slice2.retain();
        
        ByteBufUtil.log(slice1);
        ByteBufUtil.log(slice2);

        // æ›´æ”¹åŸå§‹bufferä¸­çš„å€¼
        System.out.println("===========ä¿®æ”¹åŸbufferä¸­çš„å€¼===========");
        buffer.setByte(0,5);

        System.out.println("===========æ‰“å°slice1===========");
        ByteBufUtil.log(slice1);
    }
}
```

æ³¨æ„ï¼š

- åˆ‡ç‰‡åçš„ ByteBuf åœ¨åº•å±‚ä¸Šæ˜¯å¤ç”¨çš„åŸæœ‰å†…å­˜åŒºé—´ï¼Œåˆ‡ç‰‡åçš„ max capacity è¢«å›ºå®šä¸ºè¿™ä¸ªåŒºé—´çš„å¤§å°ï¼Œå› æ­¤ä¸èƒ½åšè¿½åŠ  writeã€‚

### 2.10 duplicate

ä¹Ÿæ˜¯ã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå°±å¥½æ¯”æˆªå–äº†åŸå§‹ ByteBuf æ‰€æœ‰å†…å®¹ï¼Œå¹¶ä¸”æ²¡æœ‰ max capacity çš„é™åˆ¶ï¼Œä¹Ÿæ˜¯ä¸åŸå§‹ ByteBuf ä½¿ç”¨åŒä¸€å—åº•å±‚å†…å­˜ï¼Œåªæ˜¯è¯»å†™æŒ‡é’ˆæ˜¯ç‹¬ç«‹çš„ã€‚

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/20231118145053.png" alt="20231118145053" style="zoom:75%;" /></center>

### 2.11 copy

ä¼šå°†åº•å±‚å†…å­˜æ•°æ®è¿›è¡Œ**æ·±æ‹·è´**ï¼Œå› æ­¤æ— è®ºè¯»å†™ï¼Œéƒ½ä¸åŸå§‹ ByteBuf æ— å…³

### 2.12 CompositeByteBuf

ã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œ**å¯ä»¥å°†å¤šä¸ª ByteBuf åˆå¹¶ä¸ºä¸€ä¸ªé€»è¾‘ä¸Šçš„ ByteBuf**ï¼Œé¿å…æ‹·è´ã€‚

ç¤ºä¾‹ï¼š

```java {8}
// buf1
ByteBuf buf1 = ByteBufAllocator.DEFAULT.buffer(5);
buf1.writeBytes(new byte[]{1, 2, 3, 4, 5});
// buf2
ByteBuf buf2 = ByteBufAllocator.DEFAULT.buffer(5);
buf2.writeBytes(new byte[]{6, 7, 8, 9, 10});
// composite
CompositeByteBuf buf3 = ByteBufAllocator.DEFAULT.compositeBuffer();
// true è¡¨ç¤ºå¢åŠ æ–°çš„ ByteBuf è‡ªåŠ¨é€’å¢ write index, å¦åˆ™ write index ä¼šå§‹ç»ˆä¸º 0
buf3.addComponents(true, buf1, buf2);
```

CompositeByteBuf æ˜¯ä¸€ä¸ªç»„åˆçš„ ByteBufï¼Œå®ƒå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª Component æ•°ç»„ï¼Œæ¯ä¸ª Component ç®¡ç†ä¸€ä¸ª ByteBufï¼Œè®°å½•äº†è¿™ä¸ª ByteBuf ç›¸å¯¹äºæ•´ä½“åç§»é‡ç­‰ä¿¡æ¯ï¼Œä»£è¡¨ç€æ•´ä½“ä¸­æŸä¸€æ®µçš„æ•°æ®ã€‚

- ä¼˜ç‚¹ï¼Œå¯¹å¤–æ˜¯ä¸€ä¸ªè™šæ‹Ÿè§†å›¾ï¼Œç»„åˆè¿™äº› ByteBuf ä¸ä¼šäº§ç”Ÿå†…å­˜å¤åˆ¶
- ç¼ºç‚¹ï¼Œå¤æ‚äº†å¾ˆå¤šï¼Œå¤šæ¬¡æ“ä½œä¼šå¸¦æ¥æ€§èƒ½çš„æŸè€—

### 2.13 Unpooled

Unpooled æ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œç±»å¦‚å…¶åï¼Œæä¾›äº†éæ± åŒ–çš„ ByteBuf åˆ›å»ºã€ç»„åˆã€å¤åˆ¶ç­‰æ“ä½œ

è¿™é‡Œä»…ä»‹ç»å…¶è·Ÿã€é›¶æ‹·è´ã€‘ç›¸å…³çš„ wrappedBuffer æ–¹æ³•ï¼Œå¯ä»¥ç”¨æ¥åŒ…è£… ByteBufï¼š

```java
ByteBuf buf1 = ByteBufAllocator.DEFAULT.buffer(5);
buf1.writeBytes(new byte[]{1, 2, 3, 4, 5});
ByteBuf buf2 = ByteBufAllocator.DEFAULT.buffer(5);
buf2.writeBytes(new byte[]{6, 7, 8, 9, 10});

// å½“åŒ…è£… ByteBuf ä¸ªæ•°è¶…è¿‡ä¸€ä¸ªæ—¶, åº•å±‚ä½¿ç”¨äº† CompositeByteBuf
ByteBuf buf3 = Unpooled.wrappedBuffer(buf1, buf2);
System.out.println(ByteBufUtil.prettyHexDump(buf3));
```

ä¹Ÿå¯ä»¥ç”¨æ¥åŒ…è£…æ™®é€šå­—èŠ‚æ•°ç»„ï¼Œåº•å±‚ä¹Ÿä¸ä¼šæœ‰æ‹·è´æ“ä½œï¼š

```java
ByteBuf buf4 = Unpooled.wrappedBuffer(new byte[]{1, 2, 3}, new byte[]{4, 5, 6});
System.out.println(buf4.getClass());
System.out.println(ByteBufUtil.prettyHexDump(buf4));
```

### 2.14 ğŸ’¡ ByteBuf ä¼˜åŠ¿æ€»ç»“

- æ± åŒ– - å¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œæ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½
- è¯»å†™æŒ‡é’ˆåˆ†ç¦»ï¼Œä¸éœ€è¦åƒ ByteBuffer ä¸€æ ·åˆ‡æ¢è¯»å†™æ¨¡å¼
- å¯ä»¥è‡ªåŠ¨æ‰©å®¹
- æ”¯æŒé“¾å¼è°ƒç”¨ï¼Œä½¿ç”¨æ›´æµç•…
- å¾ˆå¤šåœ°æ–¹ä½“ç°é›¶æ‹·è´ï¼Œä¾‹å¦‚ sliceã€duplicateã€CompositeByteBuf

## 3. åŒå‘é€šä¿¡

### 3.1 ä¸€ä¸ªå…³äºè¯»å’Œå†™çš„è¯¯è§£

æˆ‘æœ€åˆåœ¨è®¤è¯†ä¸Šæœ‰è¿™æ ·çš„è¯¯åŒºï¼Œè®¤ä¸ºåªæœ‰åœ¨ nettyï¼Œnio è¿™æ ·çš„å¤šè·¯å¤ç”¨ IO æ¨¡å‹æ—¶ï¼Œè¯»å†™æ‰ä¸ä¼šç›¸äº’é˜»å¡ï¼Œæ‰å¯ä»¥å®ç°é«˜æ•ˆçš„åŒå‘é€šä¿¡ï¼Œä½†å®é™…ä¸Šï¼ŒJava Socket æ˜¯å…¨åŒå·¥çš„ï¼šåœ¨ä»»æ„æ—¶åˆ»ï¼Œçº¿è·¯ä¸Šå­˜åœ¨`A åˆ° B` å’Œ `B åˆ° A` çš„åŒå‘ä¿¡å·ä¼ è¾“ã€‚**å³ä½¿æ˜¯é˜»å¡ IOï¼Œè¯»å’Œå†™æ˜¯å¯ä»¥åŒæ—¶è¿›è¡Œçš„**ï¼Œåªè¦åˆ†åˆ«é‡‡ç”¨è¯»çº¿ç¨‹å’Œå†™çº¿ç¨‹å³å¯ï¼Œè¯»ä¸ä¼šé˜»å¡å†™ã€å†™ä¹Ÿä¸ä¼šé˜»å¡è¯»ã€‚

### 3.2 ç»ƒä¹ ï¼šecho server

ç¼–å†™ serverï¼š

```java
new ServerBootstrap()
    .group(new NioEventLoopGroup())
    .channel(NioServerSocketChannel.class)
    .childHandler(new ChannelInitializer<NioSocketChannel>() {
        @Override
        protected void initChannel(NioSocketChannel ch) {
            ch.pipeline().addLast(new ChannelInboundHandlerAdapter(){
                @Override
                public void channelRead(ChannelHandlerContext ctx, Object msg) {
                    ByteBuf buffer = (ByteBuf) msg;
                    System.out.println(buffer.toString(Charset.defaultCharset()));

                    // å»ºè®®ä½¿ç”¨ ctx.alloc() åˆ›å»º ByteBuf
                    ByteBuf response = ctx.alloc().buffer();
                    response.writeBytes(buffer);
                    ctx.writeAndFlush(response);

                    // æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ buffer å—
                    // æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ response å—
                }
            });
        }
    }).bind(8080);
```

ç¼–å†™ clientï¼š

```java
NioEventLoopGroup group = new NioEventLoopGroup();
Channel channel = new Bootstrap()
    .group(group)
    .channel(NioSocketChannel.class)
    .handler(new ChannelInitializer<NioSocketChannel>() {
        @Override
        protected void initChannel(NioSocketChannel ch) throws Exception {
            ch.pipeline().addLast(new StringEncoder());
            ch.pipeline().addLast(new ChannelInboundHandlerAdapter() {
                @Override
                public void channelRead(ChannelHandlerContext ctx, Object msg) {
                    ByteBuf buffer = (ByteBuf) msg;
                    System.out.println(buffer.toString(Charset.defaultCharset()));

                    // æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ buffer å—
                }
            });
        }
    }).connect("127.0.0.1", 8080).sync().channel();

channel.closeFuture().addListener(future -> {
    group.shutdownGracefully();
});

new Thread(() -> {
    Scanner scanner = new Scanner(System.in);
    while (true) {
        String line = scanner.nextLine();
        if ("q".equals(line)) {
            channel.close();
            break;
        }
        channel.writeAndFlush(line);
    }
}).start();
```
