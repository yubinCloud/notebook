---
title: Spring Cloud 快速入门 4：服务保护
date: 2022-03-12 12:10:09
permalink: /pages/9bd641/
categories:
  - 开发
  - Java开发
  - 微服务技术栈
tags:
  - 
---
## 1. 服务保护 —— 初识 Sentinel

### 1.1 雪崩问题及解决方案

微服务中，服务间调用关系错综复杂，一个微服务往往依赖于多个其它微服务。如果服务提供者 D 发生了故障，当前的应用的部分业务因为依赖于服务 D，因此也会被阻塞。此时，其它不依赖于服务 D 的业务似乎不受影响。但是，依赖服务 D 的业务请求被阻塞，用户不会得到响应，则 tomcat 的这个线程不会释放，于是越来越多的用户请求到来，越来越多的线程会阻塞。服务器支持的线程和并发数有限，请求一直阻塞，会**导致服务器资源耗尽，从而导致所有其它服务都不可用**，那么当前服务也就不可用了。那么，依赖于当前服务的其它服务随着时间的推移，**最终也都会变的不可用，形成级联失败**，<mark>雪崩</mark>就发生了：

<img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/image-20210715172710340.png" alt="image-20210715172710340" style="zoom: 67%;" />

解决雪崩问题的常见方式有四种：

#### :pen: 解决方案 1：超时处理

**超时处理**：设定超时时间，请求超过一定时间没有响应就返回错误信息，不会无休止等待。

> 这种方式只能缓解雪崩问题，比如等待 1s 后返回错误信息，但每秒收到 2 个请求，依然会产生雪崩。 所以**这种方案不能从根本上解决问题**。

#### :pen: 解决方案 2：仓壁模式

仓壁模式来源于船舱的设计：

<img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/image-20210715172946352.png" alt="image-20210715172946352" style="zoom:67%;" />

船舱都会被隔板分离为多个独立空间，当船体破损时，只会导致部分空间进入，**将故障控制在一定范围内**，避免整个船体都被淹没。

于此类似，我们可以**限定每个业务能使用的线程数**，避免耗尽整个 tomcat 的资源，因此也叫**线程隔离**。

> 但这种方式也会造成资源浪费，比如服务 C 挂了，但依然会出现对其的访问。

#### :pen: 解决方式 3：熔断降级

断路器模式：由**断路器**统计业务执行的异常比例，如果超出阈值则会**熔断**该业务，拦截访问该业务的一切请求。

断路器会统计访问某个服务的请求数量和异常比例，当发现访问服务 D 的请求异常比例过高时，认为服务D有导致雪崩的风险，会拦截访问服务 D 的一切请求，形成熔断。

#### :pen: 解决方式 4：流量控制

**流量控制**：限制业务访问的 QPS，避免服务因流量的突增而故障。

<img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/image-20210715173555158.png" alt="image-20210715173555158" style="zoom:50%;" />

> 流量控制是预防雪崩，前三种是出现雪崩时的解决问题。注意并不是做好流量控制就会避免雪崩问题，网络问题、假死问题等都会引起雪崩。

### 1.2 服务保护技术对比

Spring Cloud 支持多种服务保护技术，早期较流行的是 Hystrix，但目前国内实用最广泛的还是阿里巴巴的 Sentinel。它俩的对比可自行百度。

### 1.3 Sentinel 安装

Sentinel 是阿里巴巴开源的微服务流量控制组件。具有如下特征：

+ 丰富的应用场景：承接多年双十一大促的核心场景
+ 完备的实时监控：可以在控制台中看到接入应用的单台机器秒级数据
+ 广泛的开源生态：可以轻松与 Spring Cloud、Dubbo、gRPC 等整合
+ 完善的 SPI 扩展点：可以通过实现扩展接口来快速地定制逻辑，如定制规则管理、适配动态数据源等

#### 安装：

去 Github 下载 jar 包，在任意非中文目录执行：

```sh
java -jar sentinel-dashboard-1.8.1.jar
```

| 配置项                           | 默认值   | 说明       |
| -------------------------------- | -------- | ---------- |
| server.port                      | 8080     | 服务端口   |
| sentinel.dashboard.auth.username | sentinel | 默认用户名 |
| sentinel.dashboard.auth.password | sentinel | 默认密码   |

例如，修改端口：

```sh
java -Dserver.port=8090 -jar sentinel-dashboard-1.8.1.jar
```

之后在指定端口便可访问其控制台页面了。

### 1.4 微服务整合 Sentinel

我们在 order-service 中整合sentinel，并连接 sentinel 的控制台，步骤如下：

#### 1）引入依赖

```xml
<!--sentinel-->
<dependency>
    <groupId>com.alibaba.cloud</groupId> 
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
</dependency>
```

#### 2）配置控制台

修改 application.yaml 文件，添加下面内容：

```yaml {7}
server:
  port: 8088
spring:
  cloud: 
    sentinel:
      transport:
        dashboard: localhost:8080  # sentinel 控制台地址
```

#### 3）访问服务

访问 order-service 的任意端点，比如访问 `http://localhost:8088/order/101`，这样才能触发 sentinel 的监控。

这时打开 Sentinel 的控制台，可以看到效果：

<img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/image-20210715191241799.png" alt="image-20210715191241799" style="zoom:50%;" />

## 2. Sentinel 的流量控制

限流是避免服务因突发的流量而发生故障，是对微服务雪崩问题的预防。

### 2.1 簇点链路

当请求进入微服务时，首先会访问 DispatcherServlet，然后进入 Controller、Service、Mapper，这样的一个调用链就叫做**簇点链路**。簇点链路中被监控的每一个接口就是一个**资源**。默认情况下 sentinel 会监控 Spring MVC 的每一个端点（Endpoint），因此 Spring MVC 的每一个端点就是调用链路中的一个资源。

例如我们刚刚访问的 order-service 中的 OrderController 中的端点：`/order/{orderId}`：

<img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/image-20210715191757319.png" alt="image-20210715191757319" style="zoom:67%;" />

流控、熔断等都是**针对**簇点链路中的**资源来设置**的，因此我们可以点击对应资源后面的按钮来设置规则：

- 流控：流量控制
- 降级：降级熔断
- 热点：热点参数限流，是限流的一种
- 授权：请求的权限控制

### 2.2 快速入门

在 Sentinel 控制台中，点击资源 `/order/{orderId}` 后面的流控按钮，就可以弹出表单：

<img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/image-20210715191757319.png" alt="image-20210715191757319" style="zoom:67%;" />

表单中可以填写限流规则，如下：

<img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/image-20210715192010657.png" alt="image-20210715192010657" style="zoom:67%;" />

+ 其含义是限制 `/order/{orderId}` 这个资源的单机 QPS 为 1，即每秒只允许1次请求，超出的请求会被拦截并报错。

### 2.3 流控模式

在添加限流规则时，点击高级选项，可以选择三种**流控模式**：

- 直接（默认）：统计当前资源的请求，触发阈值时对当前资源直接限流，也是默认的模式
- 关联：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流
- 链路：统计从指定链路访问到本资源的请求，触发阈值时，对指定链路限流

#### 2.3.1 关联模式

**关联模式**：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流

<img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/image-20210715202540786.png" alt="image-20210715202540786" style="zoom:67%;" />

+ 当 /write 资源访问量触发阈值时，就会对 /read 资源限流，避免影响 /write 资源。

**使用场景**：比如用户支付时需要修改订单状态，同时用户要查询订单。查询和修改操作会争抢数据库锁，产生竞争。业务需求是优先支付和更新订单的业务，因此当修改订单业务触发阈值时，需要对查询订单业务限流。

**需求说明**：

- 在 OrderController 新建两个端点：/order/query 和 /order/update，无需实现业务

- 配置流控规则，当 /order/update 资源被访问的 QPS 超过 5 时，对 /order/query 请求限流

##### 1）定义两个端点

两个端点模拟订单的查询和更新业务：

```java
@GetMapping("/query")
public String queryOrder() {
    return "查询订单成功";
}

@GetMapping("/update")
public String updateOrder() {
    return "更新订单成功";
}
```

重启服务后，可以在 Sentinel 控制台的簇点链路中配置规则。

##### 2）配置流控规则

<u>对哪个端点限流，就点击哪个端点后面的按钮</u>。我们是对订单查询 /order/query 限流，因此点击它后面的按钮，并在表单中填写流控规则：

<img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/image-20210716102103814.png" alt="image-20210716102103814" style="zoom:67%;" />

::: tip 小结

满足下面的条件可以使用关联模式：

+ 两个有竞争关系的资源
+ 一个优先级较高，另一个优先级较低

:::

#### 2.3.2 链路模式

**链路模式**：只针对从指定链路访问到本资源的请求做统计，判断是否超过阈值。

**配置示例**：

例如有两条请求链路：

- /test1 --> /common

- /test2 --> /common

如果只希望统计从 /test2 进入到/common的请求，则可以这样配置：

<img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/image-20210716103536346.png" alt="image-20210716103536346" style="zoom:80%;" />

**实战案例**：有查询订单和创建订单业务，两者都需要查询商品。针对从查询订单进入到查询商品的请求统计，并设置限流。

##### 1）添加查询商品方法

在 order-service 服务中，给 OrderService 类添加一个 queryGoods 方法：

```java
@Service
public class OrderService {
    ...
    public void queryGoods() {
    	System.err.println("查询商品");
	}
}
```

##### 2）查询订单时，查询商品

在 order-service 的 OrderController 中，修改 /order/query 端点的业务逻辑：

```java
@GetMapping("/query")
public String queryOrder() {
    // 查询商品
    orderService.queryGoods();
    // 查询订单
    System.out.println("查询订单");
    return "查询订单成功";
}
```

##### 3）新增订单，查询商品

在 order-service 的 OrderController 中，修改 /order/save 端点，模拟新增订单：

```java
@GetMapping("/save")
public String saveOrder() {
    // 查询商品
    orderService.queryGoods();
    // 查询订单
    System.err.println("新增订单");
    return "新增订单成功";
}
```

##### 4）给查询商品添加资源标记

默认情况下，OrderService 中的方法是不被 Sentinel 监控的，需要我们自己通过注解来标记要监控的方法。

给 OrderService 的 queryGoods 方法添加 **@SentinelResource** 注解：

```java {1}
@SentinelResource("goods")
public void queryGoods(){
    System.err.println("查询商品");
}
```

链路模式中，是对不同来源的两个链路做监控。但是 sentinel 默认会给进入 Spring MVC 的所有请求设置同一个 root 资源，会导致链路模式失效。我们需要关闭这种对 Spring MVC 的资源聚合，修改 order-service 服务的 application.yml 文件：

```yaml
spring:
  cloud:
    sentinel:
      web-context-unify: false # 关闭context整合
```

重启服务，访问 /order/query 和 /order/save，可以查看到 sentinel 的簇点链路规则中，出现了新的资源：

<img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/image-20210716105227163.png" alt="image-20210716105227163" style="zoom:67%;" />

##### 5）添加流控规则

点击 goods 资源后面的流控按钮，在弹出的表单中填写下面信息：

<img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/image-20210716105408723.png" alt="image-20210716105408723" style="zoom:67%;" />

+ 只统计从 /order/query 进入 /goods 的资源，QPS阈值为 2，超出则被限流。

### 2.4 流控效果

