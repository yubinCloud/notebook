---
title: 分布式系统架构的本质
date: 2023-01-22 16:11:20
permalink: /pages/a81161/
categories:
  - 开发
  - 软件设计与架构
  - 专栏：左耳听风
tags:
  - 
---

> 参考：
>
> + [21 分布式系统架构的冰与火 | 极客时间](https://time.geekbang.org/column/article/1411)
> + [22 从亚马逊的实践，谈分布式系统的难点 | 极客时间](https://time.geekbang.org/column/article/1505)
> + [23 分布式系统的技术栈 | 极客时间](https://time.geekbang.org/column/article/1512)
> + [24 分布式系统关键技术：全栈监控 | 极客时间](https://time.geekbang.org/column/article/1513)

## 1. 分布式系统架构的冰与火

### 1.1 为什么需要分布式系统

首先，我们需要阐述一下为什么需要分布式系统，而不是传统的单体架构。使用分布式系统主要有两方面原因：

+ **增大系统容量**。单台机器的性能无法满足了，需要垂直或水平拆分业务系统，让其变成分布式的架构。
+ **加强系统可用**。通过分布式架构来冗余系统以消除单点故障，从而提高系统的可用性。

当然，分布式系统还有一些其他优势，比如模块化、扩展性。但这个世界上不存在完美的技术方案，都存在一种 trade-off，下面这个表格比较了单体应用和分布式架构的优缺点：

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/image-20230122205557493.png" alt="image-20230122205557493" style="zoom:80%;" /></center>

分布式系统架构的难点在于系统设计，以及管理和运维，这需要我们不断地用各式各样的技术和手段来解决这些问题。

### 1.2 分布式系统的发展

起初随着编程的发展，很自然演化出 SOA —— 基于服务的架构，它将应用程序功能作为服务发送给最终用户或者其他服务。它采用开放标准与软件资源进行交互，并采用标准的表示方式。

但 IBM 搞出来的 SOA 非常重，因此对 SOA 的裁剪和优化从来没有停过，最终改成了 RESTful 和 JSON 这样的方式，而 ESB（Enterprise Service Bus，企业服务总线）这样非常重要的东西也被简化成了 Pub/Sub 的消息服务 ……  如今，SOA 的思想也一直延续着，到了今天的分布式服务架构。

下面是一个 SOA 架构的演化图：

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/image-20230122210028392.png" alt="image-20230122210028392" style="zoom:90%;" /></center>

我们可以看到，SOA 有以下三个阶段：

+ 20 世纪 90 年代前，是单体架构，软件模块高度耦合。
+ 2000 年左右出现了比较松耦合的 SOA 架构，这个架构需要一个标准的协议或是中间件来联动其它相关联的服务（如 ESB）。服务间不直接依赖，而是通过中间件或通讯框架来实现相互依赖，**这其实是 IOC（控制反转）和 DIP（依赖倒置原则）设计思想在架构中的实践**。
+ 2010 年后，出现了微服务架构，这个架构更为松耦合。它和传统 SOA 的差别在于，服务间的整合需要一个服务编排或是服务整合的引擎来将这些微服务来组织起来。

一般来说，这个编排和组织引擎可以是工作流引擎，也可以是网关。当然还需要像 K8s 这样容器化调度的技术。

微服务的技术需要一套比较好的微服务 PaaS 平台，比如像 Spring Cloud 一样需要提供各种配置服务、服务发现、智能路由、控制总线等功能，还有像 K8s 提供的各式各样的部署和调度方式。没有这些 PaaS 层的支撑，微服务也是很难被管理和运维的。

## 2. 从亚马逊的实践，谈分布式系统的难点

### 2.1 亚马逊的实践

采用分布式系统架构后会出现很多的问题：

+ 一个线上故障的工单会在不同的服务和不同的团队中转过来转过去。
+ 每个团队都可能成为一个潜在的 DDoS 攻击者，除非每个服务都要做好配额和限流。
+ 监控和查错变得更为复杂。
+ 除非有非常强大的监控手段。服务发现和服务治理也变得非常复杂。

为了克服这些问题，亚马逊这么多年的实践让其可以运维和管理极其复杂的分布式服务架构。我觉得主要有以下几点：

1. **分布式服务的架构需要分布式的团队架构**。一个服务由一个小团队（Two Pizza Team）负责，按职责分工，而不是按技能分工。
2. **分布式服务查错不容易**。一旦出现比较严重的故障，需要整体查错。在故障发生的一开始，大家都在签到并自查自己的系统。如果没问题，也要在线待命（standby），等问题解决。
3. **没有专职的测试人员，也没有专职的运维人员，开发人员做所有的事情**。这就是著名的“Eat Your Own Dog Food”，自己写的代码自己维护自己养，会让开发人员明白，写代码容易维护代码复杂，从而使其考虑软件的长期维护性。
4. **运维优先，崇尚简化和自动化**。亚马逊十多年前就已经通过 DevOps 具备了强大的运维，并对系统进行简化和自动化，让亚马逊做到了可以轻松运维拥有上千万台虚机的 AWS 云平台。
5. **内部服务和外部服务一致**。亚马逊的内部系统都和外部系统一样对待。这样做的好处是，内部系统的服务随时都可以开放出来。而且，从第一天开始，服务提供方就有对外服务的能力。可以想象，以这样的标准运作的团队其能力会是什么样的。

分布式服务架构是需要从组织，到软件工程，再到技术上的一个大的改造，需要比较长的时间来磨合和改进，并不断地总结教训和成功经验。

### 2.2 分布式系统中需要注意的问题

#### 问题 1：异构系统的不标准问题

这主要表现在：

+ 软件和应用不标准
+ 通讯协议不标准
+ 数据格式不标准
+ 开发和运维的过程和方法不标准

分布式系统架构需要有相应的规范。比如配置管理，一个好的配置管理，应该分成三层：底层和操作系统相关，中间层和中间件相关，最上面和业务应用相关。于是底层和中间层是不能让用户灵活修改的，而是只让用户选择。比如：操作系统的相关配置应该形成模板来让人选择，而不是让人乱配置的。只有配置系统形成了规范，我们才 hold 得住众多的系统。

这样的规范还有很多，但一定要提前制定好。

#### 问题 2：系统架构中的服务依赖性问题

分布式架构下，服务是会有依赖的，一个服务依赖链上的某个服务挂掉了，可能会导致出现“多米诺骨牌”效应。所以，在分布式系统中，服务的依赖也会带来一些问题：

+ 如果非关键业务被关键业务所依赖，会导致非关键业务变成一个关键业务。
+ 服务依赖链中，出现“木桶短板效应”——整个 SLA 由最差的那个服务所决定。

这是服务治理的内容了。服务治理不但需要我们定义出服务的关键程度，还需要我们定义或是描述出关键业务或服务调用的主要路径。

这里需要注意的是，很多分布式架构在应用层上做到了业务隔离，然而，在数据库结点上并没有。如果一个非关键业务把数据库拖死，那么会导致全站不可用。所以，**数据库方面也需要做相应的隔离**。也就是说，最好一个业务线用一套自己的数据库。这就是亚马逊服务器的实践——**系统间不能读取对方的数据库，只通过服务接口耦合**。这也是微服务的要求。**我们不但要拆分服务，还要为每个服务拆分相应的数据库**。

#### 问题 3：故障发生的概率更大

而分布式系统中，虽然故障的影响面可以被隔离，但是因为机器和服务多，出故障的频率也会多。

对分布式系统架构的运维，简直就是一场噩梦。我们会慢慢地明白下面这些道理：

+ <u>出现故障不可怕，故障恢复时间过长才可怕</u>。
+ <u>出现故障不可怕，故障影响面过大才可怕</u>。

运维团队在分布式系统下会非常忙，忙到每时每刻都要处理大大小小的故障。我看到，很多大公司，都在自己的系统里拼命地添加各种监控指标，有的能够添加出几万个监控指标。我觉得这完全是在“使蛮力”。一方面，**信息太多等于没有信息**，另一方面，SLA 要求我们定义出“**Key Metrics**”，也就是所谓的关键指标。然而，他们却没有。这其实是一种思维上的懒惰。

但是“防火胜于救火”，我们还要考虑如何防火。这就需要在设计之初就要 Design for Failure，考虑如何减轻故障或者减少故障影响面。

因为当机器和服务数量越来越多时，你会发现，**人类的缺陷就成为了瓶颈**。这个缺陷就是人类无法对复杂的事情做到事无巨细的管理，只有机器自动化才能帮助人类。也就是，人管代码，代码管机器，人不管机器！

#### 问题 4：多层架构的运维复杂度更大

通常来说，**我们可以把系统分成四层：基础层、平台层、应用层和接入层**：

+ 基础层就是我们的机器、网络和存储设备等。
+ 平台层就是我们的中间件层，Tomcat、MySQL、Redis、Kafka 之类的软件。
+ 应用层就是我们的业务软件，比如，各种功能的服务。
+ 接入层就是接入用户请求的网关、负载均衡或是 CDN、DNS 这样的东西。

对于这四层，我们需要知道：任何一层的问题都会导致整体的问题；没有统一的视图和管理，导致运维被割裂开来，造成更大的复杂度。

但很多公司都是按技能分工，折让一个完整的技术系统被割裂开来，很多分工完全连不在一起，导致没有统一的运维视图，进而当出错时的查错过程变成噩梦。

**分工不是问题，问题是分工后的协作是否统一和规范**。这点，你一定要重视。

### 2.3 小结

这一节以亚马逊为例，讲了它是如何做分布式服务架构的，并遇到了哪些问题，以及是如何解决的。

构建分布式服务需要从组织，到软件工程，再到技术上的一次大的改造，需要比较长的时间来磨合和改进，并不断地总结教训和成功经验。

## 3. 分布式系统的技术栈

构建分布式系统的目的是增加系统容量，提高系统的可用性，转换成技术方面，也就是完成下面两件事：

+ 提高整体架构的吞吐量，服务更多的并发和流量
+ 提高系统的稳定性，让系统的可用性更高

### 3.1 提高架构的性能

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/image-20230128195318136.png" alt="image-20230128195318136" style="zoom:80%;" /></center>

+ **缓存系统**：提高快速访问能力最有效的手段。对于分布式系统下的缓存系统，需要的是一个缓存集群。这其中需要一个 Proxy 来做缓存的分片和路由。
+ **负载均衡系统**：是水平扩展的关键技术。
+ **异步调用**：主要通过消息队列来对请求做排队处理，这样可以把前端的请求的峰值给“削平”了，而后端通过自己能够处理的速度来处理请求。但这样降低了实时性，并引入消息丢失的问题，还会造成“有状态”的节点，从而增加了服务调度的难度。
+ **数据分区**：把数据按一定的方式分成多个区，可参考[数据分区](/pages/DDIA/note/partition/)
+ **数据镜像**：把一个数据库镜像成多份一样的数据，可参考[数据复制](/pages/DDIA/note/replication/)

对于一般公司来说，在初期，会使用读写分离的数据镜像方式，而后期会采用分库分表的方式。

### 3.2 提高架构的稳定性

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/image-20230128195928991.png" alt="image-20230128195928991" style="zoom:80%;" /></center>

+ **服务拆分**：拆分的目的主要有两个：隔离故障和模块复用。但拆分会引入服务依赖问题。
+ **服务冗余**：目的是去除单点故障，并支持服务的弹性伸缩，以及故障迁移。但对有状态的服务做冗余的话会引入更高的复杂性。
+ **限流降级**：当系统实在扛不住压力时，只能通过先停掉一部分服务，以确保整个架构不会挂掉。这些技术属于保护措施。
+ **高可用架构**：也是为了不出单点故障，技术手段主要也是从冗余的角度来考虑，比如多租户隔离、灾备多活、数据复制等。
+ **高可用运维**：主要指的是 DevOps 中的 CI/CD（持续集成 / 持续部署），一个良好的运维应该是一条很流畅的软件发布管线，其中做了足够的自动化测试，还可以做相应的灰度发布，以及对线上系统的自动化控制。这可以让宕机事件发生的时长最短。

### 3.3 分布式系统的关键技术

我们可以看到，引入分布式系统，会引入一堆技术问题，需要从以下几个方面来解决：

+ **服务治理**。包含服务拆分、服务调用、服务发现、服务依赖、服务的关键度定义……它的最大意义是需要把服务间的依赖关系、调用链和关键服务给梳理出来，并对这些服务进行性能和可用性方面的管理。
+ **架构软件管理**。主要考虑服务之间兼容性的问题。包括对整体服务所形成的的版本、生命周期进行管理，以及对服务的编排、聚合等的调度。
+ **DevOps**。快速地更新服务对服务的测试和部署都是挑战，这需要 DevOps 的全流程，包括环境构建、持续集成、持续部署。
+ **自动化运维**。对服务进行自动伸缩、故障迁移、配置管理、状态管理等一系列运维的事情借助 DevOps 进行自动化运维。
+ **资源调度管理**。应用层的自动化运维需要基础层的调度支持，也就是云计算 IaaS 层的计算、存储、网络等资源调度、隔离和管理。
+ **整体架构监控**。监控系统是你的眼睛，没有眼睛，没有数据，就无法进行高效运维。我们要对三层系统（应用层、中间件层、基础层）进行监控。
+ **流量控制**：包含负载均衡、服务路由、熔断、降级、限流等和流量相关的调度。

幸好我们生在一个比较好的时代，有了 Docker 和 K8s 这样的技术，能帮助我们解决其中很多问题。

### 3.4 分布式系统的“纲”

总结上面内容，可以发现，分布式系统主要由五个关键技术：

+ 全栈系统监控；
+ 服务 / 资源调度；
+ 流量调度；
+ 状态 / 数据调度；
+ 开发和运维的自动化。

只有把前面四项做到了，最后的开发与运维的自动化才有可能实现。所以，最为关键的就是下面这四项技术：应用整体监控、资源和服务调度、状态和数据调度及流量调度。

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/image-20230128202036030.png" alt="image-20230128202036030" style="zoom:90%;" /></center>

## 4. 分布式系统关键技术：全栈监控

