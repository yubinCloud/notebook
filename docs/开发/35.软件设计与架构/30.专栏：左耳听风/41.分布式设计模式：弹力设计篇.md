---
title: 分布式设计模式：弹力设计篇
date: 2023-02-06 00:11:36
permalink: /pages/43898a/
categories:
  - 开发
  - 软件设计与架构
  - 专栏：左耳听风
tags:
  - 

---

接下来的几章将主要谈一下分布式系统中一些比较关键的设计模式，其中包括容错、性能、管理等几个方面：

+ **容错设计又叫弹力设计**，其中着眼于分布式系统的各种“容忍”能力，包括容错能力（服务隔离、异步调用、请求幂等性）、可伸缩性（有 / 无状态的服务）、一致性（补偿事务、重试）、应对大流量的能力（熔断、降级）。可以看到，在确保系统正确性的前提下，系统的可用性是弹力设计保障的重点。
+ **管理篇**会讲述一些管理分布式系统架构的一些设计模式，比如网关方面的，边车模式，还有一些刚刚开始流行的，如 Service Mesh 相关的设计模式。
+ **性能设计篇**会讲述一些缓存、CQRS、索引表、优先级队列、业务分片等相关的架构模式。

这一章先讲弹力设计部分。

## 1. 认识故障和弹力设计

### 1.1 系统的可用性测量

对于分布式系统的容错设计，在英文中又叫 **Resiliency**（弹力）。意思是，系统在不健康、不顺，甚至出错的情况下有能力 hold 得住，挺得住，还有能在这种逆境下力挽狂澜的能力。

容错主要是为了可用性，那么，我们是怎样计算一个系统的可用性的呢？下面是一个工业界里使用的一个公式：

$$Availability = \frac{MTTF}{MTTF + MTTR}$$

其中：

+ **MTTF** 是 Mean Time To Failure，平均故障前的时间，即系统平均能够正常运行多长时间才发生一次故障。系统的可靠性越高，MTTF 越长。（注意：从字面上来说，看上去有 Failure 的字样，但其实是正常运行的时间。）
+ **MTTR** 是 Mean Time To Recovery，平均修复时间，即从故障出现到故障修复的这段时间，这段时间越短越好。

这个公式就是计算系统可用性的，也就是我们常说的，多少个 9，如下表所示。

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/image-20230212133317845.png" alt="image-20230212133317845" style="zoom:67%;" /></center>

根据上面的这个公式，为了提高可用性，我们要么提高系统的无故障时间，要么减少系统的故障恢复时间。

SLA 的几个 9 就是能持续提供可用服务的级别。

### 1.2 故障原因

在工业界中，会把服务不可用的因素分成两种：一种是有计划的，一种是无计划的。

+ **无计划的**：

  + 系统级故障，包括主机、操作系统、中间件、数据库、网络、电源以及外围设备。
  + 数据和中介的故障，包括人员误操作、硬盘故障、数据乱了。
  + 还有自然灾害、人为破坏，以及供电问题等。

+ **有计划的**：

  + 日常任务：备份，容量规划，用户和安全管理，后台批处理应用。
  + 运维相关：数据库维护、应用维护、中间件维护、操作系统维护、网络维护。
  + 升级相关：数据库、应用、中间件、操作系统、网络，包括硬件升级。

### 1.3 故障不可避免

对于大规模的分布式系统，出现故障基本上就是常态，甚至还有些你根本就不知道会出问题的地方。如果你在云平台上，或者使用了“微服务”，面对大量的 IoT 设备以及不受控制的用户流量，那么系统故障会更为复杂和变态。因为上面这些因素增加了整个系统的复杂度。

所以，要充分地意识到下面两个事：

+ 故障是正常的，而且是常见的。
+ 故障是不可预测突发的，而且相当难缠。

这告诉我们，**不要尝试着去避免故障，而是要把处理故障的代码当成正常的功能做在架构里写在代码里**。这就是为什么我们把这个设计叫做弹力（Resiliency）。

+ 一方面，在好的情况下，这个事对于我们的用户和内部运维来说是完全透明的，系统自动修复不需要人的干预。
+ 另一方面，如果修复不了，系统能够做自我保护，而不让事态变糟糕。

这就是所谓的“弹力”——能上能下。这让我想到三国杀里赵云的技能——“**能进能退乃真正法器**”。

### 1.3 小结

这一节主要讲了弹力设计的真正目的，并对系统可用性的衡量指标和故障的各种原因有所了解。

