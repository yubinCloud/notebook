---
title: Kubernetes çš„å®‰è£…ä¸åŸºæœ¬æ¶æ„
date: 2023-04-22 19:09:45
permalink: /pages/3333db/
categories:
  - è¿ç»´
  - äº‘åŸç”Ÿ
  - Kuberneteså…¥é—¨å®æˆ˜è¯¾-ç½—å‰‘é”‹
tags:
  - 
---

> å‚è€ƒï¼š[Kubernetes å…¥é—¨å®æˆ˜è¯¾ | æå®¢æ—¶é—´](https://time.geekbang.org/column/intro/100114501?tab=catalog) 9-10 è®²

## 1. åœ¨æœ¬åœ°æ­å»ºå°å·§å®Œå¤‡çš„ Kubernetes

**å®¹å™¨ç¼–æ’**ï¼ˆContainer Orchestrationï¼‰çš„äº‹å®æ ‡å‡†å°±æ˜¯ä¸“æ çš„ä¸»è§’â€”â€”Kubernetesã€‚

### 1.1 ä»€ä¹ˆæ˜¯ Kubernetesï¼Ÿ

Google å‘è¡¨ Borg è®ºæ–‡çš„åŒæ—¶ï¼Œå¹¶å°†å…¶ç”¨ Golang é‡å†™ï¼Œè¯ç”Ÿäº† Kubernetesï¼ŒåŒæ—¶ Google åˆè”åˆ Linux åŸºé‡‘ä¼šæˆç«‹äº† CNCFï¼ˆCloud Native Computing Foundationï¼Œäº‘åŸç”ŸåŸºé‡‘ä¼šï¼‰ï¼Œå¹¶å°† Kubernetes ä½œä¸ºç§å­é¡¹ç›®ï¼Œæ±‡é›†äº†ä¼—å¤šç²¾è‹±ï¼Œæ‰“è´¥äº† Apache Mesos å’Œ Docker Swarmï¼Œæˆä¸ºäº†è¿™ä¸ªé¢†åŸŸçš„å”¯ä¸€éœ¸ä¸»ã€‚

Kubernetes æ˜¯ä¸€ä¸ªç”Ÿäº§çº§åˆ«çš„å®¹å™¨ç¼–æ’å¹³å°å’Œé›†ç¾¤ç®¡ç†ç³»ç»Ÿï¼Œä¸ä»…èƒ½å¤Ÿåˆ›å»ºã€è°ƒåº¦å®¹å™¨ï¼Œè¿˜èƒ½å¤Ÿç›‘æ§ã€ç®¡ç†æœåŠ¡å™¨ã€‚

### 1.2 ä»€ä¹ˆæ˜¯ minikubeï¼Ÿ

minikube å°è€Œç¾ï¼Œä¾¿äºåˆå­¦è€…å­¦ä¹ ï¼Œå¯æ‰§è¡Œæ–‡ä»¶ä»…æœ‰ä¸åˆ°100MBï¼Œè¿è¡Œé•œåƒä¹Ÿä¸è¿‡1GBï¼Œä½†å°±åœ¨è¿™ä¹ˆå°çš„ç©ºé—´é‡Œå´é›†æˆäº†Kubernetesçš„ç»å¤§å¤šæ•°åŠŸèƒ½ç‰¹æ€§ï¼Œä¸ä»…æœ‰æ ¸å¿ƒçš„å®¹å™¨ç¼–æ’åŠŸèƒ½ï¼Œè¿˜æœ‰ä¸°å¯Œçš„æ’ä»¶ï¼Œä¾‹å¦‚Dashboardã€GPUã€Ingressã€Istioã€Kongã€Registryç­‰ç­‰ï¼Œç»¼åˆæ¥çœ‹éå¸¸å®Œå–„ã€‚

### 1.3 æ­å»º minikube

å¯ä»¥åœ¨ minikube å®˜ç½‘ä¸‹è½½å®‰è£…åŒ…ï¼Œå¦‚ä¸‹æ˜¯å®˜ç½‘å‘½ä»¤çš„æ‹·è´ï¼š

```bash
# Intel x86_64
curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64

# Apple arm64
curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-arm64

sudo install minikube /usr/local/bin/
```

å®‰è£…å®Œæˆä¹‹åï¼Œä½ å¯ä»¥æ‰§è¡Œå‘½ä»¤ `minikube version`ï¼Œçœ‹çœ‹å®ƒçš„ç‰ˆæœ¬å·ï¼ŒéªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸã€‚

```bash
$ minikube version
minikube version: v1.30.1
commit: 08896fd1dc362c097c925146c4a0d0dac715ace0
```

ä¸è¿‡ minikube åªèƒ½å¤Ÿæ­å»ºKubernetesç¯å¢ƒï¼Œè¦æ“ä½œ Kubernetesï¼Œè¿˜éœ€è¦å¦ä¸€ä¸ªä¸“é—¨çš„å®¢æˆ·ç«¯å·¥å…·ï¼š**kubectl**ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºä¸ Kubernetes åå°é€šä¿¡ï¼Œå®ç°å®¹å™¨å’Œé›†ç¾¤çš„ç®¡ç†åŠŸèƒ½ã€‚

kubectl æ˜¯ä¸€ä¸ªä¸ Kubernetesã€minikube å½¼æ­¤ç‹¬ç«‹çš„é¡¹ç›®ï¼Œæ‰€ä»¥ä¸åŒ…å«åœ¨ minikube é‡Œï¼Œä½† minikube æä¾›äº†å®‰è£…å®ƒçš„ç®€åŒ–æ–¹å¼ï¼Œä½ åªéœ€æ‰§è¡Œä¸‹é¢çš„è¿™æ¡å‘½ä»¤ï¼š

```bash
minikube kubectl
```

ä¾¿ä¼šè‡ªåŠ¨ä¸å½“å‰ Kubernetes ç‰ˆæœ¬åŒ¹é…çš„ kubectl ä¸‹è½½ä¸‹æ¥ï¼Œå¹¶å­˜åˆ°å†…éƒ¨ç›®å½•ä¸­ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å®ƒæ¥å¯¹Kubernetesâ€œå‘å·æ–½ä»¤â€äº†ã€‚

æ‰€ä»¥ï¼Œåœ¨minikubeç¯å¢ƒé‡Œï¼Œæˆ‘ä»¬ä¼šç”¨åˆ°ä¸¤ä¸ªå®¢æˆ·ç«¯ï¼šminikube ç®¡ç† Kubernetes é›†ç¾¤ç¯å¢ƒï¼Œkubectl æ“ä½œå®é™…çš„ Kubernetes åŠŸèƒ½ã€‚å¦‚ä¸‹æ˜¯ minikube çš„ç¯å¢ƒç¤ºæ„å›¾ï¼š

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/20230422205000.png" alt="20230422205000" style="zoom:75%;" /></center>

### 1.4 å®é™…éªŒè¯ minikube ç¯å¢ƒ

ç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨æœ¬æœºä¸Šè¿è¡Œ minikube æ¥åˆ›å»º Kubernetes ç¯å¢ƒäº†ã€‚

ä½¿ç”¨å‘½ä»¤ `minikube start` ä¼šä» Docker Hub ä¸Šæ‹‰å–é•œåƒï¼Œä»¥å½“å‰æœ€æ–°ç‰ˆæœ¬çš„ Kubernetes å¯åŠ¨é›†ç¾¤ã€‚ä¸è¿‡ä¸ºäº†ä¿è¯å®éªŒç¯å¢ƒçš„ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åé¢å†åŠ ä¸Šä¸€ä¸ªå‚æ•° `--kubernetes-version`ï¼Œæ˜ç¡®æŒ‡å®šè¦ä½¿ç”¨ Kubernetes ç‰ˆæœ¬ï¼š

```bash
$ minikube start --kubernetes-version=v1.23.3

ğŸ˜„  minikube v1.30.1 on Ubuntu 20.04 (amd64)
â—  minikube skips various validations when --force is supplied; this may lead to unexpected behavior
âœ¨  Automatically selected the docker driver. Other choices: none, ssh
ğŸ›‘  The "docker" driver should not be used with root privileges. If you wish to continue as root, use --force.
ğŸ’¡  If you are running minikube within a VM, consider using --driver=none:
ğŸ“˜    https://minikube.sigs.k8s.io/docs/reference/drivers/none/

ğŸ§¯  The requested memory allocation of 1987MiB does not leave room for system overhead (total system memory: 1987MiB). You may face stability issues.
ğŸ’¡  Suggestion: Start minikube with less memory allocated: 'minikube start --memory=1987mb'

ğŸ“Œ  Using Docker driver with root privileges
ğŸ‘  Starting control plane node minikube in cluster minikube
ğŸšœ  Pulling base image ...
ğŸ’¾  Downloading Kubernetes v1.23.3 preload ...
    > preloaded-images-k8s-v18-v1...:  400.43 MiB / 400.43 MiB  100.00% 11.87 M
    > index.docker.io/kicbase/sta...:  373.53 MiB / 373.53 MiB  100.00% 2.31 Mi
â—  minikube was unable to download gcr.io/k8s-minikube/kicbase:v0.0.39, but successfully downloaded docker.io/kicbase/stable:v0.0.39 as a fallback image
ğŸ”¥  Creating docker container (CPUs=2, Memory=1987MB) ...
ğŸ³  Preparing Kubernetes v1.23.3 on Docker 23.0.2 ...
âŒ  Unable to load cached images: loading cached images: stat /root/.minikube/cache/images/amd64/registry.k8s.io/coredns/coredns_v1.8.6: no such file or directory
    â–ª Generating certificates and keys ...
    â–ª Booting up control plane ...
    â–ª Configuring RBAC rules ...
ğŸ”  Verifying Kubernetes components...
    â–ª Using image gcr.io/k8s-minikube/storage-provisioner:v5
ğŸŒŸ  Enabled addons: storage-provisioner, default-storageclass
ğŸ’¡  kubectl not found. If you need it, try: 'minikube kubectl -- get pods -A'
ğŸ„  Done! kubectl is now configured to use "minikube" cluster and "default" namespace by default
```

ç°åœ¨Kubernetesé›†ç¾¤å°±å·²ç»åœ¨æˆ‘ä»¬æœ¬åœ°è¿è¡Œäº†ï¼Œä½ å¯ä»¥ä½¿ç”¨ `minikube status`ã€ `minikube node list` è¿™ä¸¤ä¸ªå‘½ä»¤æ¥æŸ¥çœ‹é›†ç¾¤çš„çŠ¶æ€ï¼š

```bash
$ minikube status
minikube
type: Control Plane
host: Running
kubelet: Running
apiserver: Running
kubeconfig: Configured

$ minikube node list
minikube        192.168.49.2
```

ä»æˆªå›¾é‡Œå¯ä»¥çœ‹åˆ°ï¼ŒKubernetes é›†ç¾¤é‡Œç°åœ¨åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåå­—å°±å«â€œminikubeâ€ï¼Œç±»å‹æ˜¯â€œControl Planeâ€ï¼Œé‡Œé¢æœ‰ hostã€kubeletã€apiserver ä¸‰ä¸ªæœåŠ¡ï¼ŒIP åœ°å€æ˜¯ 192.168.49.2ã€‚

ä½ è¿˜å¯ä»¥ç”¨å‘½ä»¤ `minikube ssh` ç™»å½•åˆ°è¿™ä¸ªèŠ‚ç‚¹ä¸Šï¼Œè™½ç„¶å®ƒæ˜¯è™šæ‹Ÿçš„ï¼Œä½†ç”¨èµ·æ¥å’Œå®æœºä¹Ÿæ²¡ä»€ä¹ˆåŒºåˆ«ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ kubectl æ¥æ“ä½œäº†ï¼Œä½† minikube è‡ªå¸¦çš„ kubectl ä¸æ­£å¸¸çš„æœ‰ä¸€ç‚¹å½¢å¼çš„åŒºåˆ«ï¼Œéœ€è¦åœ¨å‘½ä»¤å‰é¢åŠ ä¸Š minikube çš„å‰ç¼€ï¼Œåé¢å†æœ‰ä¸ª `--`ï¼Œåƒè¿™æ ·ï¼š

```bash
minikube kubectl -- version
```

ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬ä½¿ç”¨ Linux çš„ alias æ¥ä¸ºè¿™ä¸ªå¤æ‚çš„å‘½ä»¤åˆ›å»ºåˆ«åï¼ˆå†™åœ¨ `~/.bashrc`ï¼‰ä¸­ï¼š

```bash
alias kubectl="minikube kubectl --"
```

ç„¶å `source ~/.bashrc` ä½¿å…¶ç”Ÿæ•ˆã€‚

å¦å¤– kubectl æä¾›äº†å‘½ä»¤è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ï¼Œè¿è¡Œå¦‚ä¸‹å‘½ä»¤å³å¯ï¼š

```bash
source <(kubectl completion bash)
```

ç°åœ¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ„‰å¿«åœ°ä½¿ç”¨ kubectl äº†ï¼š

```bash
$ kubectl version --short
Client Version: v1.23.3
Server Version: v1.23.3
```

ä¸‹é¢æˆ‘ä»¬åœ¨ Kubernetes ä¸Šè¿è¡Œä¸€ä¸ª Nginx åº”ç”¨ï¼Œå‘½ä»¤ä¸ Docker ä¸€æ ·ï¼Œä¹Ÿæ˜¯ `run`ï¼Œä¸è¿‡å½¢å¼ä¸Šæœ‰ä¸€ç‚¹åŒºåˆ«ï¼Œéœ€è¦ç”¨ `--image` æ¥æŒ‡å®šé•œåƒï¼Œç„¶å Kubernetes ä¼šè‡ªåŠ¨æ‹‰å–å¹¶è¿è¡Œï¼š

```bash
$ kubectl run ngx --image=nginx:alpine
pod/ngx created
```

è¿™é‡Œæ¶‰åŠ Kubernetes é‡Œçš„ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼š**Pod**ï¼Œä½ å¯ä»¥æš‚æ—¶æŠŠå®ƒç†è§£æˆæ˜¯â€œç©¿äº†é©¬ç”²â€çš„å®¹å™¨ï¼ŒæŸ¥çœ‹Podåˆ—è¡¨éœ€è¦ä½¿ç”¨å‘½ä»¤ `kubectl get pod`ï¼Œå®ƒçš„æ•ˆæœç±»ä¼¼ `docker ps`ï¼š

```bash
$ kubectl get pod
NAME   READY   STATUS    RESTARTS   AGE
ngx    1/1     Running   0          26s
```

> kubectl ä¸ docker å‘½ä»¤ç±»ä¼¼ï¼Œä¹Ÿå¯ä»¥æ‹‰å–é•œåƒè¿è¡Œï¼Œä½†æ“ä½œçš„ä¸æ˜¯ç®€å•çš„å®¹å™¨ï¼Œè€Œæ˜¯ Podã€‚

å¦å¤–è¿˜è¦è¯´ä¸€ä¸‹ Kubernetes çš„å®˜ç½‘ [https://kubernetes.io/zh/](https://kubernetes.io/zh/)ï¼Œé‡Œé¢æœ‰éå¸¸è¯¦ç»†çš„æ–‡æ¡£ï¼ŒåŒ…æ‹¬æ¦‚å¿µè§£é‡Šã€å…¥é—¨æ•™ç¨‹ã€å‚è€ƒæ‰‹å†Œç­‰ç­‰ï¼Œæœ€éš¾å¾—çš„æ˜¯å®ƒæœ‰å…¨ä¸­æ–‡ç‰ˆæœ¬ï¼Œæˆ‘ä»¬é˜…è¯»èµ·æ¥å®Œå…¨ä¸ä¼šæœ‰è¯­è¨€éšœç¢ï¼Œå¸Œæœ›ä½ æœ‰æ—¶é—´å¤šä¸Šå»çœ‹çœ‹ï¼ŒåŠæ—¶è·å–å®˜æ–¹ç¬¬ä¸€æ‰‹çŸ¥è¯†ã€‚

## 2. è‡ªåŠ¨åŒ–çš„è¿ç»´ç®¡ç†ï¼šæ¢ç©¶ Kubernetes å·¥ä½œæœºåˆ¶çš„å¥¥ç§˜

è¿™ä¸€èŠ‚å°±æ¥çœ‹ä¸€ä¸‹ Kubernetes çš„å†…éƒ¨æ¶æ„å’Œå·¥ä½œæœºåˆ¶ï¼Œäº†è§£å®ƒèƒ½å‚²è§†ç¾¤é›„çš„ç§˜å¯†æ‰€åœ¨ã€‚

### 2.1 äº‘è®¡ç®—æ—¶ä»£çš„æ“ä½œç³»ç»Ÿ

Kubernetes ç®¡ç†äº†èµ„æºã€æœåŠ¡ï¼Œä»æŸç§è§’åº¦æ¥çœ‹ï¼Œå®ƒå¯ä»¥è¯´æ˜¯ä¸€ä¸ªé›†ç¾¤çº§åˆ«çš„æ“ä½œç³»ç»Ÿï¼Œä¸»è¦åŠŸèƒ½å°±æ˜¯èµ„æºç®¡ç†å’Œä½œä¸šè°ƒåº¦ã€‚Kubernetes è¿™ä¸ªæ“ä½œç³»ç»Ÿä¸ Linux è¿˜æœ‰ä¸€ç‚¹åŒºåˆ«ä½ å€¼å¾—æ³¨æ„ã€‚Linux çš„ç”¨æˆ·é€šå¸¸æ˜¯ä¸¤ç±»äººï¼š**Dev** å’Œ **Ops**ï¼Œè€Œåœ¨ Kubernetes é‡Œåˆ™åªæœ‰ä¸€ç±»äººï¼š**DevOps**ã€‚

> ç”±äºäº‘åŸç”Ÿçš„å…´èµ·ï¼Œå¼€å‘äººå‘˜ä»ä¸€å¼€å§‹å°±å¿…é¡»è€ƒè™‘åç»­çš„éƒ¨ç½²è¿ç»´å·¥ä½œï¼Œè€Œè¿ç»´äººå‘˜ä¹Ÿéœ€è¦åœ¨æ—©æœŸä»‹å…¥å¼€å‘ï¼Œæ‰èƒ½åšå¥½åº”ç”¨çš„è¿ç»´ç›‘æ§å·¥ä½œã€‚

### 2.2 Kubernetes çš„åŸºæœ¬æ¶æ„

Kubernetes çš„æ¶æ„å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/20230422211205.png" alt="20230422211205" style="zoom:75%;" /></center>

Kubernetes é‡‡ç”¨äº†ç°ä»Šæµè¡Œçš„â€œ**æ§åˆ¶é¢/æ•°æ®é¢**â€ï¼ˆControl Plane / Data Planeï¼‰æ¶æ„ï¼Œé›†ç¾¤é‡Œçš„è®¡ç®—æœºè¢«ç§°ä¸ºâ€œ**èŠ‚ç‚¹**â€ï¼ˆNodeï¼‰ï¼Œå¯ä»¥æ˜¯å®æœºä¹Ÿå¯ä»¥æ˜¯è™šæœºï¼Œå°‘é‡çš„èŠ‚ç‚¹ç”¨ä½œæ§åˆ¶é¢æ¥æ‰§è¡Œé›†ç¾¤çš„ç®¡ç†ç»´æŠ¤å·¥ä½œï¼Œå…¶ä»–çš„å¤§éƒ¨åˆ†èŠ‚ç‚¹éƒ½è¢«åˆ’å½’æ•°æ®é¢ï¼Œç”¨æ¥è·‘ä¸šåŠ¡åº”ç”¨ã€‚

- Control Plan çš„èŠ‚ç‚¹å«åš <mark>Master Node</mark>ï¼Œä¸€èˆ¬ç®€ç§° Masterï¼Œå¯ä»¥è¯´æ˜¯ Kubernetes çš„å¤§è„‘å’Œå¿ƒè„ã€‚
- Data Plan çš„èŠ‚ç‚¹å«åš <mark>Worker Node</mark>ï¼Œä¸€èˆ¬ç®€ç§° Worker æˆ– Nodeï¼Œç›¸å½“äº Kubernetes çš„æ‰‹å’Œè„šï¼Œåœ¨ Master çš„æŒ‡æŒ¥ä¸‹å¹²æ´»ã€‚

Node çš„æ•°é‡éå¸¸å¤šï¼Œæ„æˆäº†ä¸€ä¸ªèµ„æºæ± ï¼ŒKubernetes å°±åœ¨è¿™ä¸ªæ± é‡Œåˆ†é…èµ„æºï¼Œè°ƒåº¦åº”ç”¨ã€‚å› ä¸ºèµ„æºè¢«â€œæ± åŒ–â€äº†ï¼Œæ‰€ä»¥ç®¡ç†ä¹Ÿå°±å˜å¾—æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥åœ¨é›†ç¾¤ä¸­ä»»æ„æ·»åŠ æˆ–è€…åˆ é™¤èŠ‚ç‚¹ã€‚

åœ¨è¿™å¼ æ¶æ„å›¾é‡Œï¼Œæˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ª kubectlï¼Œå®ƒå°±æ˜¯ Kubernetes çš„å®¢æˆ·ç«¯å·¥å…·ï¼Œç”¨æ¥æ“ä½œ Kubernetesï¼Œä½†å®ƒä½äºé›†ç¾¤ä¹‹å¤–ï¼Œç†è®ºä¸Šä¸å±äºé›†ç¾¤ã€‚å¯ä»¥ä½¿ç”¨å‘½ä»¤ `kubectl get node` æ¥æŸ¥çœ‹ k8s çš„èŠ‚ç‚¹çŠ¶æ€ï¼š

```bash
$ kubectl get node
NAME       STATUS   ROLES                  AGE   VERSION
minikube   Ready    control-plane,master   93m   v1.23.3
```

å¯ä»¥çœ‹åˆ°å½“å‰çš„ minikube é›†ç¾¤é‡Œåªæœ‰ä¸€ä¸ª Masterï¼Œé‚£ Node æ€ä¹ˆä¸è§äº†ï¼Ÿè¿™æ˜¯å› ä¸º Master å’Œ Node çš„åˆ’åˆ†ä¸æ˜¯ç»å¯¹çš„ã€‚å½“é›†ç¾¤çš„è§„æ¨¡è¾ƒå°ï¼Œå·¥ä½œè´Ÿè½½è¾ƒå°‘çš„æ—¶å€™ï¼ŒMaster ä¹Ÿå¯ä»¥æ‰¿æ‹… Node çš„å·¥ä½œï¼Œå°±åƒæˆ‘ä»¬æ­å»ºçš„ minikube ç¯å¢ƒï¼Œå®ƒå°±åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹æ—¢æ˜¯ Master åˆæ˜¯ Nodeã€‚

### 2.3 èŠ‚ç‚¹å†…éƒ¨çš„ç»“æ„

Kubernetes çš„èŠ‚ç‚¹å†…éƒ¨ä¹Ÿå…·æœ‰å¤æ‚çš„ç»“æ„ï¼Œæ˜¯ç”±å¾ˆå¤šçš„æ¨¡å—æ„æˆçš„ï¼Œè¿™äº›æ¨¡å—åˆå¯ä»¥åˆ†æˆç»„ä»¶ï¼ˆComponentï¼‰å’Œæ’ä»¶ï¼ˆAddonï¼‰ä¸¤ç±»ï¼š

- ç»„ä»¶å®ç°äº† Kubernetes çš„æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§ï¼Œæ²¡æœ‰è¿™äº›ç»„ä»¶ Kubernetes å°±æ— æ³•å¯åŠ¨ï¼›
- æ’ä»¶åˆ™æ˜¯ Kubernetes çš„ä¸€äº›é™„åŠ åŠŸèƒ½ï¼Œå±äºâ€œé”¦ä¸Šæ·»èŠ±â€ï¼Œä¸å®‰è£…ä¹Ÿä¸ä¼šå½±å“ Kubernetes çš„æ­£å¸¸è¿è¡Œã€‚

æ¥ä¸‹æ¥æˆ‘å…ˆæ¥è®²è®² Master å’Œ Node é‡Œçš„ç»„ä»¶ï¼Œç„¶åå†æå¸¦æä¸€ä¸‹æ’ä»¶ï¼Œç†è§£äº†å®ƒä»¬çš„å·¥ä½œæµç¨‹ï¼Œä½ å°±ä¼šæ˜ç™½ä¸ºä»€ä¹ˆ Kubernetes æœ‰å¦‚æ­¤å¼ºå¤§çš„è‡ªåŠ¨åŒ–è¿ç»´èƒ½åŠ›ã€‚

#### 2.3.1 Master é‡Œçš„ç»„ä»¶æœ‰å“ªäº›ï¼Ÿ

Master é‡Œæœ‰ 4 ä¸ªç»„ä»¶ï¼Œåˆ†åˆ«æ˜¯ **apiserver**ã€**etcd**ã€**scheduler**ã€**controller-manager**ã€‚

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/20230422211941.png" alt="20230422211941" style="zoom:75%;" /></center>

- <mark>apiserver</mark>ï¼šæ•´ä¸ª Kubernetes ç³»ç»Ÿçš„å”¯ä¸€å…¥å£ï¼Œå®ƒå¯¹å¤–å…¬å¼€äº†ä¸€ç³»åˆ—çš„ RESTful APIï¼Œå¹¶ä¸”åŠ ä¸Šäº†éªŒè¯ã€æˆæƒç­‰åŠŸèƒ½ï¼Œæ‰€æœ‰å…¶ä»–ç»„ä»¶éƒ½åªèƒ½å’Œå®ƒç›´æ¥é€šä¿¡ï¼Œå¯ä»¥è¯´æ˜¯ Kubernetes é‡Œçš„è”ç»œå‘˜ã€‚
- <mark>etcd</mark>ï¼šä¸€ä¸ªé«˜å¯ç”¨çš„ KV æ•°æ®åº“ï¼Œç”¨æ¥æŒä¹…åŒ–å­˜å‚¨ç³»ç»Ÿé‡Œçš„å„ç§èµ„æºå¯¹è±¡å’ŒçŠ¶æ€ã€‚æ³¨æ„å®ƒåªä¸ apiserver æœ‰ç›´æ¥è”ç³»ï¼Œä¹Ÿå°±æ˜¯è¯´ä»»ä½•å…¶ä»–ç»„ä»¶æƒ³è¦è¯»å†™ etcd é‡Œçš„æ•°æ®éƒ½å¿…é¡»ç»è¿‡ apiserverã€‚
- <mark>scheduler</mark>ï¼šè´Ÿè´£å®¹å™¨çš„ç¼–æ’å·¥ä½œï¼Œæ£€æŸ¥èŠ‚ç‚¹çš„èµ„æºçŠ¶æ€ï¼ŒæŠŠ Pod è°ƒåº¦åˆ°æœ€é€‚åˆçš„èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œç›¸å½“äºéƒ¨ç½²äººå‘˜ã€‚å› ä¸ºèŠ‚ç‚¹çŠ¶æ€å’Œ Pod ä¿¡æ¯éƒ½å­˜å‚¨åœ¨ etcd é‡Œï¼Œæ‰€ä»¥ scheduler å¿…é¡»é€šè¿‡ apiserver æ‰èƒ½è·å¾—ã€‚
- <mark>controller-manager</mark>ï¼šè´Ÿè´£ç»´æŠ¤å®¹å™¨å’ŒèŠ‚ç‚¹ç­‰èµ„æºçš„çŠ¶æ€ï¼Œå®ç°æ•…éšœæ£€æµ‹ã€æœåŠ¡è¿ç§»ã€åº”ç”¨ä¼¸ç¼©ç­‰åŠŸèƒ½ï¼Œç›¸å½“äºç›‘æ§è¿ç»´äººå‘˜ã€‚åŒæ ·åœ°ï¼Œå®ƒä¹Ÿå¿…é¡»é€šè¿‡ apiserver è·å¾—å­˜å‚¨åœ¨ etcd é‡Œçš„ä¿¡æ¯ï¼Œæ‰èƒ½å¤Ÿå®ç°å¯¹èµ„æºçš„å„ç§æ“ä½œã€‚

è¿™4ä¸ªç»„ä»¶ä¹Ÿéƒ½è¢«å®¹å™¨åŒ–äº†ï¼Œè¿è¡Œåœ¨é›†ç¾¤çš„ Pod é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ kubectl æ¥æŸ¥çœ‹å®ƒä»¬çš„çŠ¶æ€ï¼Œä½¿ç”¨å‘½ä»¤ï¼š

```bash {4,5,6,8}
$ kubectl get pod -n kube-system
NAME                               READY   STATUS             RESTARTS   AGE
coredns-64897985d-64hv8            1/1     Running            0          100m
etcd-minikube                      1/1     Running            0          100m
kube-apiserver-minikube            1/1     Running            0          100m
kube-controller-manager-minikube   1/1     Running            0          100m
kube-proxy-r2b4g                   1/1     Running            0          100m
kube-scheduler-minikube            1/1     Running            0          100m
storage-provisioner                0/1     ImagePullBackOff   0          100m
```

#### 2.3.2 Node é‡Œçš„ç»„ä»¶æœ‰å“ªäº›ï¼Ÿ

Masteré‡Œçš„apiserverã€schedulerç­‰ç»„ä»¶éœ€è¦è·å–èŠ‚ç‚¹çš„å„ç§ä¿¡æ¯æ‰èƒ½å¤Ÿä½œå‡ºç®¡ç†å†³ç­–ï¼Œé‚£è¿™äº›ä¿¡æ¯è¯¥æ€ä¹ˆæ¥å‘¢ï¼Ÿè¿™å°±éœ€è¦Nodeé‡Œçš„3ä¸ªç»„ä»¶äº†ï¼Œåˆ†åˆ«æ˜¯ **kubelet**ã€**kube-proxy**ã€**container-runtime**ï¼š

- <mark>kubelet</mark>ï¼šNode çš„ä»£ç†ï¼Œè´Ÿè´£ç®¡ç† Node ç›¸å…³çš„ç»å¤§éƒ¨åˆ†æ“ä½œï¼ŒNode ä¸Šåªæœ‰å®ƒèƒ½å¤Ÿä¸ apiserver é€šä¿¡ï¼Œå®ç°çŠ¶æ€æŠ¥å‘Šã€å‘½ä»¤ä¸‹å‘ã€å¯åœå®¹å™¨ç­‰åŠŸèƒ½ï¼Œç›¸å½“äºæ˜¯ Node ä¸Šçš„ä¸€ä¸ªâ€œå°ç®¡å®¶â€ã€‚
- <mark>kube-proxy</mark>ï¼šNode çš„ç½‘ç»œä»£ç†ï¼Œåªè´Ÿè´£ç®¡ç†å®¹å™¨çš„ç½‘ç»œé€šä¿¡ï¼Œç®€å•æ¥è¯´å°±æ˜¯ä¸º Pod è½¬å‘ TCP/UDP æ•°æ®åŒ…ï¼Œç›¸å½“äºæ˜¯ä¸“èŒçš„â€œå°é‚®å·®â€ã€‚
- <mark>container-runtime</mark>ï¼šå®ƒæ˜¯å®¹å™¨å’Œé•œåƒçš„å®é™…ä½¿ç”¨è€…ï¼Œé€šå¸¸ä¸º Dockerï¼Œåœ¨ kubelet çš„æŒ‡æŒ¥ä¸‹åˆ›å»ºå®¹å™¨ï¼Œç®¡ç† Pod çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ˜¯çœŸæ­£å¹²æ´»çš„â€œè‹¦åŠ›â€ã€‚

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/20230422213035.png" alt="20230422213035" style="zoom:75%;" /></center>

> æˆ‘ä»¬ä¸€å®šè¦æ³¨æ„ï¼Œå› ä¸º Kubernetes çš„å®šä½æ˜¯å®¹å™¨ç¼–æ’å¹³å°ï¼Œæ‰€ä»¥å®ƒæ²¡æœ‰é™å®š container-runtime å¿…é¡»æ˜¯ Dockerï¼Œå®Œå…¨å¯ä»¥æ›¿æ¢æˆä»»ä½•ç¬¦åˆæ ‡å‡†çš„å…¶ä»–å®¹å™¨è¿è¡Œæ—¶ï¼Œä¾‹å¦‚ containerdã€CRI-O ç­‰ç­‰ï¼Œåªä¸è¿‡åœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Dockerã€‚

è¿™3ä¸ªç»„ä»¶ä¸­åªæœ‰ kube-proxy è¢«å®¹å™¨åŒ–äº†ï¼Œè€Œ kubelet å› ä¸ºå¿…é¡»è¦ç®¡ç†æ•´ä¸ªèŠ‚ç‚¹ï¼Œå®¹å™¨åŒ–ä¼šé™åˆ¶å®ƒçš„èƒ½åŠ›ï¼Œæ‰€ä»¥å®ƒå¿…é¡»åœ¨ container-runtime ä¹‹å¤–è¿è¡Œã€‚

ä½¿ç”¨ `minikube ssh` å‘½ä»¤ç™»å½•åˆ°èŠ‚ç‚¹åï¼Œå¯ä»¥ç”¨ `docker ps` çœ‹åˆ° kube-proxyï¼š

```bash {1,4}
$ minikube ssh
Last login: Sat Apr 22 11:43:55 2023 from 192.168.49.1

docker@minikube:~$ docker ps | grep kube-proxy
2089b7b713b1   9b7cc9982109           "/usr/local/bin/kubeâ€¦"   2 hours ago      Up 2 hours                k8s_kube-proxy_kube-proxy-r2b4g_kube-system_86dd0c2b-f392-4327-82b8-32422e441a75_0
4d3598fc2131   k8s.gcr.io/pause:3.6   "/pause"                 2 hours ago      Up 2 hours                k8s_POD_kube-proxy-r2b4g_kube-system_86dd0c2b-f392-4327-82b8-32422e441a75_0
```

è€Œ kubelet ç”¨ `docker ps` æ˜¯æ‰¾ä¸åˆ°çš„ï¼Œéœ€è¦ç”¨æ“ä½œç³»ç»Ÿçš„ `ps` å‘½ä»¤ï¼š

```bash
ps -ef | grep kubelet
```

ç°åœ¨ï¼Œæˆ‘ä»¬å†æŠŠ Node é‡Œçš„ç»„ä»¶å’Œ Master é‡Œçš„ç»„ä»¶æ”¾åœ¨ä¸€èµ·æ¥çœ‹ï¼Œå°±èƒ½å¤Ÿæ˜ç™½ Kubernetes çš„å¤§è‡´å·¥ä½œæµç¨‹äº†ï¼š

- æ¯ä¸ª Node ä¸Šçš„ kubelet ä¼šå®šæœŸå‘ apiserver ä¸ŠæŠ¥èŠ‚ç‚¹çŠ¶æ€ï¼Œapiserver å†å­˜åˆ° etcd é‡Œã€‚
- æ¯ä¸ª Node ä¸Šçš„ kube-proxy å®ç°äº† TCP/UDP åå‘ä»£ç†ï¼Œè®©å®¹å™¨å¯¹å¤–æä¾›ç¨³å®šçš„æœåŠ¡ã€‚
- scheduler é€šè¿‡ apiserver å¾—åˆ°å½“å‰çš„èŠ‚ç‚¹çŠ¶æ€ï¼Œè°ƒåº¦ Podï¼Œç„¶å apiserver ä¸‹å‘å‘½ä»¤ç»™æŸä¸ª Node çš„ kubeletï¼Œkubelet è°ƒç”¨ container-runtime å¯åŠ¨å®¹å™¨ã€‚
- controller-manager ä¹Ÿé€šè¿‡ apiserver å¾—åˆ°å®æ—¶çš„èŠ‚ç‚¹çŠ¶æ€ï¼Œç›‘æ§å¯èƒ½çš„å¼‚å¸¸æƒ…å†µï¼Œå†ä½¿ç”¨ç›¸åº”çš„æ‰‹æ®µå»è°ƒèŠ‚æ¢å¤ã€‚

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/20230422213621.png" alt="20230422213621" style="zoom:75%;" /></center>

å…¶å®ï¼Œè¿™å’Œæˆ‘ä»¬åœ¨ Kubernetes å‡ºç°ä¹‹å‰çš„æ“ä½œæµç¨‹ä¹Ÿå·®ä¸äº†å¤šå°‘ï¼Œä½† Kubernetes çš„é«˜æ˜ä¹‹å¤„å°±åœ¨äºæŠŠè¿™äº›éƒ½æŠ½è±¡åŒ–è§„èŒƒåŒ–äº†ã€‚äºæ˜¯ï¼Œè¿™äº›ç»„ä»¶å°±å¥½åƒæ˜¯æ— æ•°ä¸ªä¸çŸ¥ç–²å€¦çš„è¿ç»´å·¥ç¨‹å¸ˆï¼ŒæŠŠåŸå…ˆç¹çä½æ•ˆçš„äººåŠ›å·¥ä½œæ¬è¿›äº†é«˜æ•ˆçš„è®¡ç®—æœºé‡Œï¼Œå°±èƒ½å¤Ÿéšæ—¶å‘ç°é›†ç¾¤é‡Œçš„å˜åŒ–å’Œå¼‚å¸¸ï¼Œå†äº’ç›¸åä½œï¼Œç»´æŠ¤é›†ç¾¤çš„å¥åº·çŠ¶æ€ã€‚

#### 2.3.3 æ’ä»¶ï¼ˆAddonsï¼‰æœ‰å“ªäº›ï¼Ÿ

åªè¦æœåŠ¡å™¨èŠ‚ç‚¹ä¸Šè¿è¡Œäº† apiserverã€schedulerã€kubeletã€kube-proxyã€container-runtime ç­‰ç»„ä»¶ï¼Œå°±å¯ä»¥è¯´æ˜¯ä¸€ä¸ªåŠŸèƒ½é½å…¨çš„ Kubernetes é›†ç¾¤äº†ã€‚

ä¸è¿‡å°±åƒLinuxä¸€æ ·ï¼Œæ“ä½œç³»ç»Ÿæä¾›çš„åŸºç¡€åŠŸèƒ½è™½ç„¶â€œå¯ç”¨â€ï¼Œä½†æƒ³è¾¾åˆ°â€œå¥½ç”¨â€çš„ç¨‹åº¦ï¼Œè¿˜æ˜¯è¦å†å®‰è£…ä¸€äº›é™„åŠ åŠŸèƒ½ï¼Œè¿™åœ¨Kubernetesé‡Œå°±æ˜¯æ’ä»¶ï¼ˆAddonï¼‰ã€‚ç”±äºKubernetesæœ¬èº«çš„è®¾è®¡éå¸¸çµæ´»ï¼Œæ‰€ä»¥å°±æœ‰å¤§é‡çš„æ’ä»¶ç”¨æ¥æ‰©å±•ã€å¢å¼ºå®ƒå¯¹åº”ç”¨å’Œé›†ç¾¤çš„ç®¡ç†èƒ½åŠ›ã€‚

minikubeä¹Ÿæ”¯æŒå¾ˆå¤šçš„æ’ä»¶ï¼Œä½¿ç”¨å‘½ä»¤ `minikube addons list` å°±å¯ä»¥æŸ¥çœ‹æ’ä»¶åˆ—è¡¨ï¼š

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/20230422213807.png" alt="20230422213807" style="zoom:75%;" /></center>

æ’ä»¶ä¸­æˆ‘ä¸ªäººè®¤ä¸ºæ¯”è¾ƒé‡è¦çš„æœ‰ä¸¤ä¸ªï¼š**DNS** å’Œ **Dashboard**ã€‚

- <mark>DNS</mark> åœ¨ Kubernetes é›†ç¾¤é‡Œå®ç°äº†åŸŸåè§£ææœåŠ¡ï¼Œèƒ½å¤Ÿè®©æˆ‘ä»¬ä»¥åŸŸåè€Œä¸æ˜¯ IP åœ°å€çš„æ–¹å¼æ¥äº’ç›¸é€šä¿¡ï¼Œæ˜¯æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡çš„åŸºç¡€ã€‚ç”±äºå®ƒå¯¹å¾®æœåŠ¡ã€æœåŠ¡ç½‘æ ¼ç­‰æ¶æ„è‡³å…³é‡è¦ï¼Œæ‰€ä»¥åŸºæœ¬ä¸Šæ˜¯ Kubernetes çš„å¿…å¤‡æ’ä»¶ã€‚
- <mark>Dashboard</mark> å°±æ˜¯ä»ªè¡¨ç›˜ï¼Œä¸º Kubernetes æä¾›äº†ä¸€ä¸ªå›¾å½¢åŒ–çš„æ“ä½œç•Œé¢ï¼Œéå¸¸ç›´è§‚å‹å¥½ï¼Œè™½ç„¶å¤§å¤šæ•° Kubernetes å·¥ä½œéƒ½æ˜¯ä½¿ç”¨å‘½ä»¤è¡Œ kubectlï¼Œä½†æœ‰çš„æ—¶å€™åœ¨ Dashboard ä¸ŠæŸ¥çœ‹ä¿¡æ¯ä¹Ÿæ˜¯æŒºæ–¹ä¾¿çš„ã€‚

ä½ åªè¦åœ¨ minikube ç¯å¢ƒé‡Œæ‰§è¡Œä¸€æ¡ç®€å•çš„å‘½ä»¤ï¼Œå°±å¯ä»¥è‡ªåŠ¨ç”¨æµè§ˆå™¨æ‰“å¼€ Dashboard é¡µé¢ï¼Œè€Œä¸”è¿˜æ”¯æŒä¸­æ–‡ï¼š

```bash
minikube dashboard
```

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/20230422214034.png" alt="20230422214034" style="zoom:75%;" /></center>

### 2.4 å°ç»“

å°ç»“ä¸€ä¸‹è¿™ä¸€èŠ‚çš„è¦ç‚¹ï¼š

1. Kubernetes èƒ½å¤Ÿåœ¨é›†ç¾¤çº§åˆ«ç®¡ç†åº”ç”¨å’ŒæœåŠ¡å™¨ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç§é›†ç¾¤æ“ä½œç³»ç»Ÿã€‚å®ƒä½¿ç”¨â€œæ§åˆ¶é¢/æ•°æ®é¢â€çš„åŸºæœ¬æ¶æ„ï¼ŒMaster èŠ‚ç‚¹å®ç°ç®¡ç†æ§åˆ¶åŠŸèƒ½ï¼ŒWorker èŠ‚ç‚¹è¿è¡Œå…·ä½“ä¸šåŠ¡ã€‚
2. Kubernetes ç”±å¾ˆå¤šæ¨¡å—ç»„æˆï¼Œå¯åˆ†ä¸ºæ ¸å¿ƒçš„ç»„ä»¶å’Œé€‰é…çš„æ’ä»¶ä¸¤ç±»ã€‚
3. Master é‡Œæœ‰ 4 ä¸ªç»„ä»¶ï¼Œåˆ†åˆ«æ˜¯ apiserverã€etcdã€schedulerã€controller-managerã€‚
4. Node é‡Œæœ‰ 3 ä¸ªç»„ä»¶ï¼Œåˆ†åˆ«æ˜¯ kubeletã€kube-proxyã€container-runtimeã€‚
5. é€šå¸¸å¿…å¤‡çš„æ’ä»¶æœ‰ DNS å’Œ Dashboardã€‚

è¯¾å¤–å°è´´å£«ï¼š

- ä¸ºç¡®ä¿æ§åˆ¶é¢çš„é«˜å¯ç”¨ï¼ŒKubernetes é›†ç¾¤é‡Œéƒ½ä¼šéƒ¨ç½²å¤šä¸ª Master èŠ‚ç‚¹ï¼Œæ•°é‡ä¸€èˆ¬ä¼šæ˜¯å¥‡æ•° (3/5/7)ï¼Œè¿™æ˜¯ç”± etcd çš„ç‰¹æ€§å†³å®šçš„ã€‚
- etcd ç”± CoreOS å…¬å¸å¼€å‘ï¼ŒåŸºäºç±» Paxos çš„ Raft ç®—æ³•å®ç°æ•°æ®ä¸€è‡´æ€§ã€‚
- controller-manager æ˜¯å¾ˆå¤šä¸ª controller çš„é›†åˆä½“æ¯ä¸€ä¸ª controller è´Ÿè´£ä¸€ç§æ§åˆ¶å¾ªç¯ (å¦‚ node con-trollerã€namespace controller)ï¼Œä½†ä¸ºäº†ç®€åŒ–è¢«åˆå¹¶åœ¨ä¸€ä¸ªè¿›ç¨‹é‡Œæ‰§è¡Œã€‚
- minikube çš„ Dashboard åªå…è®¸åœ¨æœ¬æœºè¿è¡Œçš„æµè§ˆå™¨è®¿é—®ï¼Œä¸è¿‡ä½ ä¹Ÿå¯ä»¥ç»™å®ƒé…ç½® Nginx åå‘ä»£ç†ã€‚

