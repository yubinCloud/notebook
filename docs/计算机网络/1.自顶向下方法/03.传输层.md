---
title: 传输层
date: 2021-10-19 22:39:43
permalink: /pages/6750bc/
categories:
  - 计算机网络
tags:
  - 计网
---

[[toc]]

::: tip 考试大纲

1. 传输层的功能 
2. 复用与分解 
3. 传输层寻址与端口号、无连接服务与面向连接服务 
4. 流量控制与拥塞控制 
5. 可靠数据传输、停止—等待协议、滑动窗口协议（后退 N 步协议-GBN、 选择重传协议-SR）、协议信道利用率 
6. UDP 数据报、UDP 校验 
7. TCP 协议特点、TCP 段结构、TCP 连接管理、TCP 可靠传输、TCP 流量控制与拥塞控制

:::

## 1. 概述与传输层服务

传输层协议为运行在不同主机上的进程提供了一种逻辑（而非物理）通信机制，在端系统中实现。

+ 发送方：将应用递交的消息分成一个或多个的报文段，并向下传给网络层。
+ 接收方：将接收到的报文段组装成消息， 并向上交给应用层。

传输层的数据分组称为**报文段（segment）**。

网络路由器仅作用于数据报的网络层字段，即他们不检查传输层报文段的字段。

可以使用多种运输层协议，因特网提供了 TCP 和 UDP 两种协议。

::: note 传输层 vs. 网络层

网络层：提供主机之间的逻辑通信机制；

传输层：提供应用进程之间的逻辑通信机制。

:::

UDP（用户数据报协议）：“尽力而为”的不可靠、无连接的服务；

TCP（传输控制协议）：可靠的、面向连接的服务。

均不保证延迟和带宽。

> 我们将传输层分组称为报文段，但有些因特网文献称 TCP 分组为报文段，UDP 分组为数据报。我们统称都为报文段，以免与网络层的分组“数据报”混淆。

## 2. 多路复用和多路分解

这项技术的**目的**：将由网络层提供的主机到主机交付服务延伸到为运行在主机上的应用程序提供进程到进程的交付服务。

> 如果某层的一个协议对应直接上层的多个协议/实体，则需要多路复用/分用。

在接收主机中的运输层实际上并没有直接将数据交付给进程，而是将数据交给了一个中间套接字。任一时刻不只有一个套接字。每个套接字都有唯一的标识符：

+ UDP Socket 标识符：（dst-ip，dst-port）
+ TCP Socket 标识符：（src-ip，src-port，dst-ip，dst-port）

![image-20211019230729435](../images/image-20211019230729435.png)

将传输层报文段中的数据交付给正确的套接字的工作称为**多路分解**；

在源主机从不同套接字中收集数据块，并为每个数据块封装上首部信息从而生成报文段，然后将报文段传递到网络层，所有这些工作称为**多路复用**。



**端口号**：16 比特的数，范围 0 ~ 65535，0 ~ 1023 是周知端口号。

### 2.1 无连接的多路复用与多路分解

一个 UDP 由一个（dst-ip，dst-port）标识。如果两个 UDP 报文段有着不同的源 ip 或源端口号，但具有相同的目的 ip 和目的端口，那么这两个报文将通过相同的套接字被定向到相同的目的进程。

> 但这不是说接收方就无法获得源 ip 和源端口号了，只是不把他作为标识而已。

### 2.2 面向连接的多路复用与多路分解

一个 TCP 套接字由 （src-ip，src-port，dst-ip，dst-port）标识。

+ 服务器可能同时支持多个TCP  Socket；
+ Web服务器为每个客户端开不同的 Socket

![image-20211019232251467](../images/image-20211019232251467.png)

## 3. UDP

+ “Best effort”服务，UDP段可能丢失或非按序到达。
+ 无连接，UDP发送方和接收方之间不需要握手，每个UDP段的处理独立于其他段

::: details UDP 为什么存在

+ 无需建立连接 (减少延迟) 
+ 实现简单：无需维护连接状态 
+ 头部开销少 
+ 没有拥塞控制: 应用可更好地控制发送时间和速度

:::

使用 UDP 的应用是可能实现可靠传输的，这可以通过在应用程序自身中建立可靠机制来完成。

### 3.1 UDP 报文段结构

![image-20211019235444862](../images/image-20211019235444862.png)

+ UDP 首部只有四个字段，每个字段由两个字节组成，共 8 个字段。
+ 长度字段指示了在 UDP 报文段中的字节数（首部 + 数据）

### 3.2 UDP 检验和

::: note UDP 为什么提供了检验和？

虽然许多链路层协议也提供了差错检测，但不能保证所有链路都提供了差错检测。此外，即使报文段经链路正确地传输，当报文段存储在某台路由器的内存中时，也可能引入比特差错。在既无法确保逐链路的可靠性，又无法确保内存中的差错检测的情况下，如果端到端数据传输服务要提供差错检测，UDP 就必须在端到端的基础上在运输层提供差错检测，这是一个在系统设计中被称颂的**端到端原则**的例子。

端到端原则：因为某种功能必须基于端到端实现，在与较高级别提供这些功能的代价相比，在较低级别上设置的功能可能是冗余的或几乎没有价值的。

:::

UDP 检验和提供了差错检测功能，用于确定当 UDP 报文段从源到达目的地移动时，其中的比特是否发生了改变。但他对差错恢复无能为力。

**发送方**：将段的内容视为16-bit整数。<u>校验和计算</u>：计算所有整数的和 ，进位加在和的后面而不是丢弃（称为回卷），将得到的值按位求反，得到校验和。发送方将校验和放入校验和字段。

**接收方**：计算所收到段的校验和，将其与校验和字段进行对比：不相等则检测出错误，相等则没有检测出错误（<u>但可能有错误</u>）。

::: details 校验和计算示例

![image-20211020000513835](../images/image-20211020000513835.png)

:::

## 4. 可靠数据传输的原理

