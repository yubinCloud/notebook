有时候我们用 requests 得到的页面和我们在浏览器中所看到的不一样，这是因为 requests 获取的都是原始的 HTML 文档，而浏览器中的页面是 JavaScript 处理数据之后生成的结果，这些数据有多种来源，可能是通过 Ajax 加载的，也可能是包含在 HTML 文档中的，还可能是经过 JS 和特定算法生成的。

当页面数据是通过 Ajax 请求获得的时候，需要分析请求接口，并对请求接口进行抓取来获得数据。

## 1. 什么是 Ajax

Ajax 允许通过与场景后面的 Web 服务器交换数据来异步更新网页。这意味着可以更新网页的部分，而不需要重新加载整个页面。

以微博 `https://m.weibo.cn/u/2830678474` 为例，可以一直下滑查看更多微博，但始终未发生页面 URL 的变化，这后面刷新出来的数据就是 Ajax 请求得到的。

### 基本原理

JavaScript 实现 Ajax 请求的代码如下：

```javascript
var xhttp;
if (window.XMLHttpRequest) {
    xhttp = new XMLHttpRequest();
    } else {
    // code for IE6, IE5
     xhttp = new ActiveXObject("Microsoft.XMLHTTP");
}
xhttp.onreadystatechange = function() {
  if (this.readyState == 4 && this.status == 200) {
    document.getElementById("demo").innerHTML = this.responseText;
  }
};
xhttp.open("GET", "/test-api", true);
xhttp.send();
```

+ 整个过程就是先新建一个 XMLHttpRequest 对象 xhttp，然后调用 onreadystatechange 属性设置监听，最后调用 open 和 send 方法向某个连接发送请求。

真实的网页数据其实就是一次次向服务器发送 Ajax 请求得到的，要想抓取这些数据，需要知道 Ajax 请求到底是怎么发送的、发往哪里、发了哪些参数。我们知道了这些信息后，便可以用 Python 来模拟发送请求来获取数据。

## 2. Ajax 分析方法

仍然以 `https://m.weibo.cn/u/2830678474` 为例，打开页面后在浏览器中打开开发者工具的 Network 部分，可以看到所有网络请求。**Ajax 有其特殊的请求类型，叫做 xhr**，也可以利用筛选功能筛选出 XHR 的请求：

![image-20220113001424349](https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/image-20220113001424349.png)

点击该请求可以看到详细信息，其中在 Request Headers 中有一个信息为 `X-Requested-With: XMLHttpRequest`，这就标记了此请求是 Ajax 请求。

随后单击一下 Preview 或者 Response 选项卡就可以看到返回的数据。