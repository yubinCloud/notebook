---
title: count(*) 这么慢，该怎么办？
date: 2023-06-02 11:29:00
permalink: /pages/mysql/geektime/count-star/
categories:
  - 数据科学
  - MySQL
  - MySQL 实战 45 讲
tags:
  - 
---

## 1. count(*) 这么慢，我该怎么办？

系统中的统计部分经常需要 `select count(*) from t`，但你会发现，随着系统中记录数越来越多，这条语句执行得也会越来越慢。

这一章主要聊一下 `count(*)` 到底是怎样实现的，以及 MySQL 为什么会这样实现。然后，我会再和你说说，如果应用中有这种频繁变更并需要统计表行数的需求，业务设计上可以怎么做。

### 1.1 `count(*)` 的实现方式

在不同的 MySQL 引擎中，count(*) 有不同的实现方式：

- MyISAM 引擎把一个表的总行数存在了磁盘上，因此执行 `count(*)` 的时候会直接返回这个数，效率很高；
- 而 InnoDB 引擎就麻烦了，它执行 `count(*)` 的时候，需要把数据一行一行地从引擎里面读出来，然后累积计数。

> 这里需要注意的是，我们在这篇文章里讨论的是没有过滤条件的 `count(*)`，如果加了 where 条件的话，MyISAM 表也是不能返回得这么快的。

在前面，我们已经知道，InnoDB 无论在事务支持、并发能力还是数据安全方面，都是优于 MyISAM，所以我们也往往选择它，这也就是当我们的记录数越来越多的时候，计算一个表的总行数会越来越慢的原因。

那**为什么 InnoDB 不跟 MyISAM 一样，也把 count 结果存起来呢**？这是因为即使是在同一个时刻的多个查询，由于多版本并发控制（MVCC）的原因，InnoDB 表“应该返回多少行”也是不确定的。这里，我用一个算 `count(*)` 的例子来为你解释一下。

假设表 t 中现在有 10000 条记录，我们设计了三个用户并行的会话：

- 会话 A 先启动事务并查询一次表的总行数；
- 会话 B 启动事务，插入一行后记录后，查询表的总行数；
- 会话 C 先启动一个单独的语句，插入一行记录后，查询表的总行数。

我们假设从上到下是按照时间顺序执行的，同一行语句是在同一时刻执行的：

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/20230602201050.png" alt="20230602201050" style="zoom:75%;" /></center>

<center><font color=grey>图 1 会话 A、B、C 的执行流程</font></center>

你会看到，在最后一个时刻，三个会话 A、B、C 会同时查询表 t 的总行数，但拿到的结果却不同。这和 InnoDB 的事务设计有关系，可重复读是它默认的隔离级别，在代码上就是通过多版本并发控制，也就是 MVCC 来实现的。每一行记录都要判断自己是否对这个会话可见，因此对于 count(*) 请求来说，InnoDB 只好把数据一行一行地读出依次判断，可见的行才能够用于计算“基于这个查询”的表的总行数。

当然，现在这个看上去笨笨的 MySQL，在执行 `count(*)` 操作的时候还是做了优化的。你知道的，InnoDB 是索引组织表，主键索引树的叶子节点是数据，而普通索引树的叶子节点是主键值。所以，普通索引树比主键索引树小很多。对于 `count(*)` 这样的操作，遍历哪个索引树得到的结果逻辑上都是一样的。因此，MySQL 优化器会找到最小的那棵树来遍历。**在保证逻辑正确的前提下，尽量减少扫描的数据量，是数据库系统设计的通用法则之一**。

如果你用过 show table status 命令的话，就会发现这个命令的输出结果里面也有一个 TABLE_ROWS 用于显示这个表当前有多少行，这个命令执行挺快的，那这个 TABLE_ROWS 能代替 `count(*)` 吗？

答案是不能。之前我们知道，索引统计的值是通过采样来估算的，这里的 TABLE_ROWS 也是从这个采样估算得来的，因此它很不准，官方文档说误差可能达到 40% 到 50%。所以，**show table status 命令显示的行数也不能直接使用**。

到这里我们小结一下：

- MyISAM 表虽然 `count(*)` 很快，但是不支持事务；
- show table status 命令虽然返回很快，但是不准确；
- InnoDB 表直接 `count(*)` 会遍历全表，虽然结果准确，但会导致性能问题。

那么，回到文章开头的问题，如果你现在有一个页面经常要显示交易系统的操作记录总数，到底应该怎么办呢？答案是，我们只能自己计数。接下来，我们讨论一下，看看自己计数有哪些方法，以及每种方法的优缺点有哪些。

这里，我先和你说一下这些方法的**基本思路：你需要自己找一个地方，把操作记录表的行数存起来**。

### 1.2 用缓存系统来保存计数
